<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Marriage Rate in Malaysia (Female Focus)</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@6"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@6"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@7"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <style>
/* ====== PAGE LAYOUT STYLE (1080p MAX) ====== */
/* ===============================
   GLOBAL PAGE LAYOUT
================================= */
body {
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  background-color: #dcdcdc; /* Light grey page sides */
}

.main-container {
  max-width: 1600px;
  width: 100%;
  background-color: #FFF8DC; /* 🌼 Cornsilk tone */
  margin: 40px auto;
  padding: 40px 50px;
  border-radius: 12px;
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  box-sizing: border-box;
  border: none;
}

/* ===============================
   TYPOGRAPHY
================================= */

/* Main title */
#mainTitle {
  font-family: 'Playfair Display', serif;
  font-size: 46px;
  text-align: center;
  /* color: #5A3E00; */

  color: black;

  margin: 10px 0 8px 0;
  letter-spacing: 1px;
}

/* Subtitle */
#subTitle {
  font-family: 'Times New Roman', Times, serif;
  text-align: center;
  font-size: 20px;
  /* color: #6B5200; */
    color: black;

  margin-bottom: 35px;
  letter-spacing: 0.3px;
}

/* Section titles */
h2 {
  text-align: center;
  color: #111;
  font-family: 'Times New Roman', Times, serif;
  font-size: 30px;
  margin: 60px 0 15px 0;
  letter-spacing: 0.3px;
}

/* Subsection titles */
h3 {
  text-align: center;
  color: #111;
  font-family: 'Times New Roman', Times, serif;
  font-size: 22px;
  font-weight: bold;
  letter-spacing: 0.3px;
}

/* Text and paragraph styling */
p, label, button, #analysisSection, #areaText, #lineChartText, #heatmapText {
  font-family: Arial, sans-serif;
  color: #2E2E2E;
  line-height: 1.7;
  font-size: 15.5px;
}

/* ===============================
   VISUALISATION + CARD STYLE
================================= */

#waffleChart {
  background-color: white !important;
  margin: 0 auto;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0 !important;         /* remove inner padding */
  min-height: unset !important;  /* remove forced height */
  height: auto !important;
  overflow: visible;             /* allow chart edges to breathe */
}





.mapBox,
#areaChart,
#genderDiffHeatmap,
#waffleChart,
#analysisSection {
  background-color: #FFFFFF;
border: 1px solid #ccc;
  border-radius: 10px;
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  padding: 15px;
}

#maleMultiLineChart,
#femaleMultiLineChart {
  background: none;      /* remove white background */
  border: none;          /* no border outline */
  box-shadow: none;      /* remove drop shadow */
  padding: 0;            /* remove inner spacing */
}

/* ===============================
   SIDE-BY-SIDE CHARTS (MAP & MULTI-LINE)
================================= */
#mapContainer,
#lineChartContainer {
  display: flex;
  justify-content: space-between;    /* distribute both evenly */
  align-items: stretch;
  flex-wrap: nowrap;                 /* ✅ keep both charts in one row */
  gap: 20px;
  width: 100%;
  max-width: 1600px;
  margin: 20px auto 40px auto;
  box-sizing: border-box;
}

/* ✅ Each chart box auto-scales and keeps proper ratio */
.mapBox {
  flex: 1 1 48%;
  min-width: 480px;
  aspect-ratio: 4 / 3;
  background: white;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  padding: 35px 40px 30px 40px; /* 🔸 Added internal space */
  overflow: visible;            /* let annotations breathe */
  transition: all 0.3s ease;
}


/* ===============================
   RESPONSIVE AUTO-RESIZE
================================= */
@media (max-width: 1400px) {
  .mapBox {
    min-width: 420px;
    aspect-ratio: 4 / 3;
  }
}

@media (max-width: 1200px) {
  #mapContainer,
  #lineChartContainer {
    gap: 10px;
  }
  .mapBox {
    flex: 1 1 48%;
    transform: scale(0.9);           /* shrink both equally */
    transform-origin: top center;
  }
}

@media (max-width: 1000px) {
  .mapBox {
    transform: scale(0.8);
  }
}

@media (max-width: 800px) {
  #mapContainer,
  #lineChartContainer {
    flex-direction: column;          /* ✅ finally stack vertically */
    align-items: center;
  }
  .mapBox {
    width: 95%;
    transform: scale(1);
    min-width: 0;
  }
}


/* Center all charts */
#areaChartContainer,
#waffleChart,
#maleMultiLineChart,
#femaleMultiLineChart,
#maleVis,
#femaleVis {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 auto;
}

#genderDiffHeatmap {
  display: flex;
  justify-content: center;     /* 🔸 horizontally center the chart */
  align-items: center;         /* 🔸 vertically center it */
  width: 100%;
  margin: 0 auto;
  padding: 10px 0;             /* small breathing space top-bottom */
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  overflow: visible !important;
  box-sizing: border-box;
}
/* ===============================
   AREA CHART + FINDINGS BOX
================================= */
/* === AREA CHART CONTAINER & CHART === */
#areaChartContainer {
  width: 100%;
  max-width: 1600px;
  margin: 0 auto 20px auto;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: stretch;   /* ✅ stretch vertically */
  height: 400px;          /* ✅ fixed proportional height */
  box-sizing: border-box;
}

#areaChart {
  padding: 0;           /* ✅ remove any inner padding */
  margin: 0; 
    height: 100%;
  width: 100%;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  box-sizing: border-box;
  overflow: hidden;       /* ✅ prevent Vega SVG overflow */
}




#areaText,
#lineChartText,
#heatmapText,
#analysisSection {
  max-width: 1600px;  /* ✅ uniform width */
  margin: 25px auto;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 25px;
  text-align: center;
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  font-size: 15px;
  line-height: 1.6;
}


/* ===============================
   HEATMAP + WAFFLE (FLAT GRAPH INSIDE WHITE BOX)
================================= */
#heatmapWaffleContainer {
  display: flex;
  justify-content: space-between;
  align-items: stretch;
  gap: 25px;
  width: 100%;
  max-width: 1600px;
  margin: 30px auto;
  box-sizing: border-box;
}

/* 🔸 White rounded container behind chart */
.halfCard {
  flex: 1 1 48%;
  background: #ffffff;             /* white box background */
  border: 1px solid #ccc;          /* light border */
  border-radius: 10px;             /* rounded corners */
  box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* soft shadow behind */
  padding: 20px;                   /* space inside for chart */
  box-sizing: border-box;
  overflow: hidden;
  
}

/* 🔹 The chart itself: no background or shadow */
#genderDiffHeatmap,
#waffleChart {
  width: 100%;
  margin: 0 auto;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  overflow: visible !important;
}

/* Remove Vega embed default frame */
.vega-embed,
.vega-embed > div {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 0 !important;
}

/* Stack vertically on smaller screens */
@media (max-width: 900px) {
  #heatmapWaffleContainer {
    flex-direction: column;
    align-items: center;
  }
  .halfCard {
    width: 95%;
  }
}

/* 
/* ===============================
   CHECKBOX + BUTTON CONTROLS
================================= */
/* 
.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  max-width: 800px;
  margin: 0 auto;
}

.checkbox-group label {
  background: #f7f5ff;
  border: 1px solid #bbb;
  padding: 5px 10px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  user-select: none;
}

/* Select All button */
#selectAllBtn {
  background-color: #ddd;
  border: 1px solid #aaa;
  border-radius: 5px;
  padding: 5px 10px;
  font-size: 13px;
  cursor: pointer;
  margin-top: 10px;
  transition: background-color 0.2s ease;
}
#selectAllBtn:hover,
button:hover {
  background-color: #e5cc80;
  border-color: #d8b74a;
  color: #3B2C00;
}

/* Consistent visualisation card style */
.card {
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
} */ */

/* ===============================
   MISC ALIGNMENT
================================= */
h2, h3, #controls, #ageCheckboxContainer {
  text-align: center;
  margin-left: auto;
  margin-right: auto;
}

/* Tooltip, legend, and axis font consistency */
.vg-tooltip,
.vega-legend,
.vega-axis,
.vg-tooltip-content {
  font-family: Arial, sans-serif !important;
  font-size: 13px !important;
  color: #3B2C00 !important;
}

  </style>
</head>
<body>
  <div class="main-container">
    <h1 id="mainTitle">Marriage Trends in Malaysia, 2017–2022</h1>
<p id="subTitle">An analytical overview of marriage rates<br>across gender, age, and regions</p>



<!-- ✅ AREA CHART CARD SECTION -->
<div id="areaChartCard" style="
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  padding: 30px 40px 35px 40px;
  max-width: 1600px;
  margin: 30px auto;
  box-sizing: border-box;
">

  <!-- Title -->
  <h2 style="
    margin: 0 0 20px 0;
    font-family: 'Times New Roman';
    color: #2e2e2e;
    text-align: center;
  ">
    Marriage Trends in Malaysia (2017–2022)
  </h2>

  <!-- Chart -->
  <div id="areaChart" style="
    width: 100%;
    height: 380px;
    margin: 0 auto;
  "></div>

  <!-- Toggle Button (centered) -->
  <div style="
    text-align: center;
    margin-top: 20px;
  ">
    <button id="toggleChartBtn" style="
      background-color: #FFD580;        /* 🌼 Soft golden color */
      border: 1px solid #CFA15E;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: bold;
      color: #4B2E05;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    ">
      Switch to Marriage Rate (Line Chart)
    </button>
  </div>

</div>

<!-- ✅ Button Hover Effects -->
<style>
#toggleChartBtn:hover {
  background-color: #FFB347;           /* deeper orange hover */
  border-color: #A66615;
  color: #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.25);
}
#toggleChartBtn:active {
  background-color: #E69500;
  transform: scale(0.97);
}
</style>

<!-- 🟣 AREA CHART SUMMARY (Consistent Layout) -->
<div id="areaText" class="card" style="
  max-width: 1600px;
  margin: 40px auto 60px auto;
  padding: 50px 80px;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  font-family: Arial, sans-serif;
  color: #333;
  text-align: justify;
">
  <div style="
    column-count: 2;
    column-gap: 60px;
    font-size: 25px;
    line-height: 2.1;
  ">
    Between <b>2017 and 2022</b>, Malaysia’s <b>marriage trend</b> remained 
    generally stable, with a <b>sharp drop in 2020</b> due to 
    <b>pandemic restrictions</b>. The decline reflected the impact of 
    nationwide <b>movement control orders</b> and <b>ceremony postponements</b> 
    during the crisis period.

    The rate <b>rebounded strongly in 2021</b> as restrictions eased and 
    continued to <b>stabilise in 2022</b>, showing a <b>full recovery</b> after 
    disruption.<br>These results highlight <b>resilience in Malaysian marriage 
    patterns</b> despite temporary <b>social and economic challenges</b>.

    <br><br>
    <span style="color:#CE93D8; font-weight:bold;">Female marriage rates</span> 
    were generally higher across most regions, reflecting earlier marriage norms 
    and stronger cultural influence, while 
    <span style="color:#E59442; font-weight:bold;">Male marriage rates</span> 
    fluctuated more due to migration and economic factors.
  </div>
</div>





    <!-- All your charts, maps, titles, controls go here -->
    <h2 id="chartTitle">Male & Female Marriage Rate in Malaysia, 2022 (All Ages)</h2>

<div id="controls" style="text-align:center; margin:20px 0;">
  <label for="yearSlider" style="font-weight:bold;">Year:</label>
  <input type="range" id="yearSlider" min="2017" max="2022" value="2022" step="1"
    style="width:300px; vertical-align:middle; margin:0 10px;" />
  <span id="yearLabel" class="small" style="font-weight:bold;">2022</span>
</div>



<div id="mapContainer">
  <div class="mapBox">
    <h3 style="text-align:center;">Male Marriage Rate</h3>
    <div id="maleVis"></div>
  </div>
  <div class="mapBox">
    <h3 style="text-align:center;">Female Marriage Rate</h3>
    <div id="femaleVis"></div>
  </div>
</div>
<div id="vis"></div>

<<!-- 🟣 MAP ANALYSIS TEXT (Consistent Layout) -->
<div id="mapText" class="card" style="
  max-width: 1600px;
  margin: 40px auto 60px auto;
  padding: 50px 80px;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  font-family: Arial, sans-serif;
  color: #333;
  text-align: justify;
">
  <div style="
    column-count: 2;
    column-gap: 60px;
    font-size: 25px;
    line-height: 2.1;
  ">
    <b style="color:#CE93D8;">Female marriage rates</b> were higher across most 
    states, especially in <b>Kedah, Terengganu,</b> and <b>Kelantan</b>, showing 
    stronger <b>cultural</b> and <b>religious influence</b>. 
    <b style="color:#E59442;">Male marriage rates</b> fluctuated more with higher 
    values in <b>Negeri Sembilan</b> and lower in <b>Sabah</b>, mainly due to 
    <b>migration</b> and <b>economic factors</b>.

    <b>Urban areas</b> such as <b>Kuala Lumpur</b> and <b>Putrajaya</b> showed 
    higher <b style="color:#E59442;">male</b> than 
    <b style="color:#CE93D8;">female marriage rates</b>, linked to 
    <b>modern lifestyles</b> and <b>delayed marriage decisions</b>. 
    <b>Rural</b> and <b>traditional states</b> maintained steadier marriage 
    activity for both genders, reflecting <b>strong cultural roots</b> in Malaysia.
  </div>
</div>




    <h2>Marriage Rate by Age Group (2017–2022)</h2>


<div id="lineChartContainer">
  <div class="mapBox">
    <h3 style="text-align:center;">Male Marriage Rate by Age Group</h3>
    <div id="maleMultiLineChart"></div>
  </div>
  <div class="mapBox">
    <h3 style="text-align:center;">Female Marriage Rate by Age Group</h3>
    <div id="femaleMultiLineChart"></div>
  </div>
</div>
<!-- 🟡 MULTILINE CHART INSIGHT (Two Columns + Gender Color Highlights) -->
<div id="lineChartText" class="card" style="
  max-width: 1600px;
  margin: 40px auto 60px auto;
  padding: 50px 80px;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  font-family: Arial, sans-serif;
  color: #333;
  text-align: justify;
">

  <div style="
    column-count: 2;
    column-gap: 60px;
    font-size: 25px;
    line-height: 2.1;
  ">
    <b style="color:#E59442;">Male marriage rates</b> were generally lower
    than <b style="color:#CE93D8;">female marriage rates</b> across all years,
    but both showed a <b>similar upward pattern</b> for the
    <b>30–34 age group</b>. This <b>convergence</b> suggests that marriage is
    increasingly concentrated in the <b>early thirties</b> for both genders.
    The steady rise in this group reflects a
    <b>societal shift toward later marriage</b>, likely influenced by
    <b>financial planning</b>, <b>career focus</b>, and
    <b>changing lifestyle priorities</b> among Malaysians.
  </div>
</div>



<!-- 🔽 Responsive Layout -->
<style>
  @media (max-width: 900px) {
    #lineChartText div {
      column-count: 1;              /* 🪄 goes back to 1 column on small screens */
    }
  }
</style>




<!-- ✅ GENDER DIFFERENCE & PROPORTION SECTION -->
<h2 style="
  text-align:center;
  font-family:'Times New Roman';
  color:#2e2e2e;
  margin-bottom:25px;
">
  Gender Difference & Proportion of Marriages (2022)
</h2>

<!-- 🟣 CHART CONTAINER -->
<div id="heatmapWaffleContainer" style="
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 30px;
  max-width: 1600px;
  margin: 0 auto 40px auto;
">

  <!-- 🟣 LEFT: Heatmap -->
  <div id="genderDiffHeatmapContainer" class="halfCard" style="
    flex: 1 1 48%;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    padding: 25px 35px 35px 35px;
    box-sizing: border-box;
  ">
    <h3 style="text-align:center; margin-top:8px;">
      Gender Difference Heatmap (Male − Female)
    </h3>
    <div id="genderDiffHeatmap"></div>
  </div>

  <!-- 🟡 RIGHT: Waffle -->
  <div id="waffleChartContainer" class="halfCard" style="
    flex: 1 1 48%;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    padding: 25px 35px 35px 35px;
    box-sizing: border-box;
  ">
    <h3 style="text-align:center; margin-top:8px;">
      Proportion of Marriages by Gender (All Ages, 2022)
    </h3>
    <div id="waffleChart"></div>
  </div>
</div>
<!-- 🟣 GENDER INSIGHT SECTION (Two Separate Cards - Consistent Layout) -->
<div id="genderInsightContainer" style="
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 40px;
  max-width: 1600px;
  margin: 40px auto 60px auto;
  align-items: stretch;
">

  <!-- 💜 LEFT CARD -->
  <div style="
    flex: 1 1 48%;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    padding: 50px 60px;
    font-family: Arial, sans-serif;
    font-size: 25px;
    line-height: 2.1;
    text-align: justify;
    box-sizing: border-box;
  ">
    Malaysian <b style="color:#CE93D8;">women</b> continue to marry 
    <b>younger</b> and in <b>higher numbers</b>, while 
    <b style="color:#E59442;">men</b> increasingly <b>delay marriage</b> or 
    <b>remarry later</b> in life.  
    This reflects growing <b>gender gaps</b> in 
    <b>marriage timing</b>, driven by 
    <b style="color:#CE93D8;">women</b> entering marriage 
    <b>earlier</b> and <b style="color:#E59442;">men</b> prioritising 
    <b>career</b> or <b>financial stability</b> before settling down.
  </div>

  <!-- 🟠 RIGHT CARD -->
  <div style="
    flex: 1 1 48%;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    padding: 50px 60px;
    font-family: Arial, sans-serif;
    font-size: 25px;
    line-height: 2.1;
    text-align: justify;
    box-sizing: border-box;
  ">
    <b style="color:#CE93D8;">Female marriage rate</b> (<b>25.5</b>) was 
    <b>higher</b> than <b style="color:#E59442;">male</b> (<b>22.7</b>), 
    showing <b style="color:#CE93D8;">women</b> married more 
    <b>actively</b> and <b>earlier</b>.  
    <b style="color:#E59442;">Men’s</b> <b>lower rate</b> suggests 
    <b>delayed marriage</b> due to <b>career</b> or 
    <b>financial factors</b>, while 
    <b style="color:#CE93D8;">women’s</b> <b>higher rate</b> reflects 
    <b>stronger participation</b> and 
    <b>traditional expectations</b> in forming families.
  </div>

</div>





<!-- 🔶 ANALYSIS SUMMARY (Two Columns + Gender Color Highlights) -->
<div id="analysisSection" class="card" style="
  max-width: 1600px;
  margin: 40px auto 60px auto;
  padding: 50px 80px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  font-family: Arial, sans-serif;
  color: #333;
  text-align: justify;
">

  <h3 style="
    text-align:center;
    font-family:'Times New Roman';
    font-weight:bold;
    font-size:28px;
    color:black;
    margin-bottom:25px;
  ">
    Overall Insights & Implications
  </h3>

  <div style="
    column-count: 2;
    column-gap: 60px;
    font-size: 25px;
    line-height: 2.1;
  ">
    From <b>2017 to 2022</b>, Malaysia’s marriage trend shows that
    people are marrying later, with most marriages now concentrated
    in the <b>early thirties</b>. While 
    <b style="color:#CE93D8;">women</b> still marry earlier and more
    frequently than <b style="color:#E59442;">men</b>, both genders
    are delaying marriage due to <b>financial pressure</b>, 
    <b>career priorities</b>, and <b>lifestyle changes</b>.<br><br>

    This shift reflects <b>growing independence</b> and <b>maturity</b> 
    but may lead to future issues like <b>lower birth rates</b> and an 
    <b>ageing population</b>, as fewer couples marry or have children early.
    Overall, Malaysia’s marriage trend highlights 
    <b>social progress</b> but also signals a 
    <b>demographic challenge</b> that could affect the nation’s 
    <b>long-term population balance</b>.
  </div>
</div>

<!-- ===============================
     📄 METADATA FOOTER (bottom-left)
=============================== -->
<footer style="
  position: relative;
  bottom: 0;
  left: 0;
  width: 100%;
  text-align: left;
  padding: 10px 40px;
  font-size: 13px;
  font-family: Arial, sans-serif;
  color: #555;
  background: transparent;
  margin-top: 40px;
  box-sizing: border-box;
">
  <p style="margin: 2px 0;"><strong>Author:</strong> Beh Zhi Yin</p>
  <p style="margin: 2px 0;"><strong>Date:</strong> 21 October 2025</p>
  <p style="margin: 2px 0;"><strong>Data Sources:</strong> 
    Department of Statistics Malaysia (DOSM);Data.GOV.MY
  </p>
</footer>



</body>


  <script>
    const STATE_YEAR_AGEGROUP_CSV = "https://raw.githubusercontent.com/ZhiYin1018/3179-A2/refs/heads/main/data/state_year_agegroup_marriage";
    const TOPOJSON_URL  = "https://raw.githubusercontent.com/ZhiYin1018/3179-A2/refs/heads/main/data/malaysia-states.topojson";
    const YEAR_AGEGROUP_CSV    = "https://raw.githubusercontent.com/ZhiYin1018/3179-A2/refs/heads/main/data/year_agegroup.csv";
    const YEAR_TREND_CSV    = "https://raw.githubusercontent.com/ZhiYin1018/3179-A2/refs/heads/main/data/year_trend.csv";
  
    const allAges = ["< 20","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65+"];

      const drawMap = (selectedSex, selectedYear, containerId) => {
      document.getElementById("chartTitle").textContent =
        `${selectedSex.charAt(0).toUpperCase() + selectedSex.slice(1)} Marriage Rate in Malaysia, ${selectedYear} (All Ages)`;

const colorRange = selectedSex === "female"
  // 💜 Purple gradient (light lavender → deep violet)
  ? ["#F3E5F5", "#E1BEE7", "#CE93D8", "#BA68C8", "#8E24AA", "#4A148C"]
  // 🟤 Orange-brown gradient (soft amber → deep brown-orange)
  : ["#FFE5B4", "#F2B179", "#E59442", "#CC7722", "#A65E1E", "#703800"];

      const spec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": 900,
        "height": 420,
        "background": "#cfeefb",
"projection": {
  "type": "mercator",
  "center": [111, 2.5],
  "scale": currentZoom,
  "translate": [currentPan.x, currentPan.y]
},


        "layer": [
          { "data": { "sphere": true }, "mark": { "type": "geoshape", "fill": "#cfeefb" } },
          {
            "data": { "graticule": { "step": [5, 5] } },
            "mark": { "type": "geoshape", "stroke": "#a0a8b0", "strokeWidth": 0.45, "opacity": 0.8 }
          },
          {
            "data": { "graticule": { "step": [90, 90] } },
            "mark": { "type": "geoshape", "stroke": "#8a949e", "strokeWidth": 1 }
          },
          {
            "data": { "url": STATE_YEAR_AGEGROUP_CSV, "format": { "type": "csv" } },
            "transform": [
              { "calculate": "toNumber(datum.year || (substring(datum.date,0,4)))", "as": "year" },
              { "filter": `datum.year == ${selectedYear}` },
            { "filter": `datum.sex == '${selectedSex}'` },  
              { "filter": "datum.age == 'all'" },
              {
                "lookup": "state",
                "from": {
                  "data": { "url": TOPOJSON_URL, "format": { "type": "topojson", "feature": "gadm41_MYS_1" } },
                  "key": "properties.NAME_1"
                },
                "as": "geo"
              },
              { "filter": "datum.geo != null" }
            ],
            "mark": { "type": "geoshape", "stroke": "#fff", "strokeWidth": 0.6 },
            "encoding": {
              "shape": { "field": "geo", "type": "geojson" },
              "color": {
                "field": "rate",
                "type": "quantitative",
                "scale": { "type": "threshold", "domain": [18, 22, 25, 28, 32], "range": colorRange },
                "legend": {
                  "title": "Marriage Rate (per 1000)",
                  "orient": "bottom-right",
                  "direction": "horizontal",
                  "titleFont": "Arial",
                  "titleFontSize": 13,
                  "labelFont": "Arial",
                  "labelFontSize": 12,
                  "titleColor": "#4b3b00",
                  "labelColor": "#4b3b00"
                }
              },
              "tooltip": [
                { "field": "state", "title": "State" },
                { "field": "rate", "title": "Marriage Rate" },
                { "field": "year", "title": "Year" }
              ]
            }
          },

    // === ANNOTATION LINES ===
// === ANNOTATION LINES ===
{
  "data": {
    "values": [
      // ===== MALE: line ends match the male TEXT coords =====
      // 2017
      { "year": 2017, "sex": "male", "lon": 101.9, "lat": 2.8, "lon_end": 104.6, "lat_end": 3.1 }, // Negeri Sembilan → text (105, 3.3)

      // 2018
      { "year": 2018, "sex": "male", "lon": 102.2, "lat": 2.2, "lon_end": 104.3, "lat_end": 2.4 }, // Melaka → text (105, 2.4)

      // 2019
      { "year": 2019, "sex": "male", "lon": 101.9, "lat": 2.8, "lon_end": 104, "lat_end": 3.1 }, // Negeri Sembilan → text (104.2, 3.1)

      // 2020
      { "year": 2020, "sex": "male", "lon": 100.2, "lat": 6.5, "lon_end": 101.7, "lat_end": 6.7 }, // Perlis → text (101.8, 6.7)

      // 2021
      { "year": 2021, "sex": "male", "lon": 102.4, "lat": 6.1, "lon_end": 104.8, "lat_end": 6.45 }, // Kelantan → text (104.9, 6.45)

      // 2022
      { "year": 2022, "sex": "male", "lon": 102.4, "lat": 6.1, "lon_end": 104.9, "lat_end": 6.3 },  // Kelantan → text (105.0, 6.3)

      // ===== FEMALE: keep lines aligned to female TEXT coords =====
      // 2017
      { "year": 2017, "sex": "female", "lon": 102.3, "lat": 6.0, "lon_end": 104.0, "lat_end": 6.3 }, // Kelantan → text (104.3, 6.3)

      // 2018
      { "year": 2018, "sex": "female", "lon": 102.0, "lat": 6.0, "lon_end": 104.2, "lat_end": 5.2 }, // Terengganu/Kelantan → text (104.2, 5.2)

      // 2019
      { "year": 2019, "sex": "female", "lon": 101.7, "lat": 2.9, "lon_end": 104, "lat_end": 3.7 }, // Putrajaya → text (104, 3.7)

      // 2020
      { "year": 2020, "sex": "female", "lon": 102.3, "lat": 6.0, "lon_end": 104.3, "lat_end": 6.2 }, // Kelantan → text (104.5, 6.2)

      // 2021
      { "year": 2021, "sex": "female", "lon": 100.4, "lat": 6.2, "lon_end": 103.9, "lat_end": 6.4 }, // Kedah → text (104.0, 6.4)

      // 2022
      { "year": 2022, "sex": "female", "lon": 102.3, "lat": 6.0, "lon_end": 103.9, "lat_end": 6.2 }, // Kelantan → text (104.0, 6.2)
    ]
  },
  "transform": [
    { "filter": `datum.year == ${selectedYear}` },
    { "filter": `datum.sex == '${selectedSex}'` }
  ],
  "mark": {
    "type": "rule",
    "stroke": selectedSex === "male" ? "#003366" : "black",
    "strokeWidth": 1.2
  },
  "encoding": {
    "longitude": { "field": "lon", "type": "quantitative" },
    "latitude": { "field": "lat", "type": "quantitative" },
    "longitude2": { "field": "lon_end" },
    "latitude2": { "field": "lat_end" }
  }
}
,
    // === ANNOTATION TEXTS ===
    {
"data": {
  "values": [

      { "year": 2017, "sex": "male", "text": "Negeri Sembilan's men /n led Peninsular /nMalaysia.", "lon": 105, "lat": 3.3 },

    { "year": 2018, "sex": "male", "text": "Melaka's /n registrations /nslowed slightly./nBacklogs delayed many weddings", "lon": 105, "lat": 2.4 },

    { "year": 2019, "sex": "male", "text": "Early marriage norms /nstill persisted", "lon": 104.5, "lat": 3.1 },

    { "year": 2020, "sex": "male", "text": "Perlis saw the steepest pandemic drop", "lon": 101.8, "lat": 6.7 },

    { "year": 2021, "sex": "male", "text": "Kelantan was the fastest /n rebound nationwide.", "lon": 104.9, "lat": 6.45 },

    { "year": 2022, "sex": "male", "text": "Kelantan remained Malaysia's /n highest male rate /n in 2011 & 2022", "lon": 105.0, "lat": 6.3 },

    // === FEMALE ANNOTATIONS ===
    { "year": 2017, "sex": "female", "text": "Kelantan's women marry earlier./n Customs kept rates above 30%", "lon": 104.3, "lat": 6.3 },

    { "year": 2018, "sex": "female", "text": "Terengganu and Kelantan led again./nFaith-based norms /nstayed strong.", "lon": 104.2, "lat": 5.2 },

    { "year": 2019, "sex": "female", "text": "Putrajaya's modern lifestyle /ncause rate fell slightly.", "lon": 104, "lat": 3.7 },

    { "year": 2020, "sex": "female", "text": "Religious weddings continued/n despite MCO", "lon": 104.5, "lat": 6.2 },

    { "year": 2021, "sex": "female", "text": "Kedah's rural rebound was strong./nIt outpaced industrial states.", "lon": 104.0, "lat": 6.4 },

    { "year": 2022, "sex": "female", "text": "Kelantan's women remained highest./nTraditions kept rates near 32.3%", "lon": 104.0, "lat": 6.2 }
  ]
}
,
      "transform": [
        { "filter": `datum.year == ${selectedYear}` },
        { "filter": `datum.sex == '${selectedSex}'` }
      ],
"mark": {
  "type": "text",
  "font": "Arial",
  "fontSize": 28,
  "align": "left",
  "color": "#000000",
  "dx": -4,
  "dy": -2,
  "lineBreak": "/n"
},

      "encoding": {
        "longitude": { "field": "lon", "type": "quantitative" },
        "latitude": { "field": "lat", "type": "quantitative" },
        "text": { "field": "text" }
      }
    }
  ]
};
    vegaEmbed(containerId, spec, { renderer: "svg", actions: false, tooltip: { theme: "custom" } })
    .then(res => {
        // Apply custom tooltip styling
        const tooltipEl = document.querySelector('.vg-tooltip');
        if (tooltipEl) {
        tooltipEl.style.fontFamily = 'Arial, sans-serif';
        tooltipEl.style.fontSize = '12px';
        tooltipEl.style.fontWeight = 'normal';
        tooltipEl.style.color = '#000';
        }
    })
    .catch(console.error);
    };

 let currentChartType = "bar"; // 🟡 default = bar chart (number of marriages)

 
const drawAreaChart = (chartType = "bar") => {
  const isLine = chartType === "line";

  // Base chart spec
  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Malaysia Marriage Trends (2017–2022)",
    "data": { "url": YEAR_TREND_CSV, "format": { "type": "csv" } },
    "transform": [
      { "calculate": "toNumber(datum.date)", "as": "year" },
      { "filter": "datum.year >= 2017 && datum.year <= 2022" }
    ],
    "width": "container",
    "height": 350,
    "autosize": { "type": "fit", "contains": "content" },
    "background": "white",
    "layer": [],
    "config": {
      "axis": {
        "labelFont": "Arial",
        "labelFontSize": 12,
        "titleFont": "Arial",
        "titleFontSize": 13,
        "titleFontWeight": "bold"
      },
      "view": { "stroke": "transparent" },
      "style": {
        "tooltip": {
          "font": "Arial",
          "fontSize": 13,
          "fontWeight": "normal",
          "fill": "#000",
          "stroke": "none"
        }
      }
    }
  };

  // 🟣 Main line/bar chart
  spec.layer.push({
    "mark": isLine
      ? { "type": "line", "color": "#E75480", "strokeWidth": 3, "interpolate": "monotone" }
      : { "type": "bar", "color": "#F8BBD0", "cornerRadiusEnd": 3, "opacity": 0.9 },
    "encoding": {
      "x": {
        "field": "year",
        "type": "ordinal",
        "title": "Year",
        "axis": { "labelAngle": 0 }
      },
      "y": {
        "field": isLine ? "rate" : "abs",
        "type": "quantitative",
        "title": isLine
          ? "Marriage Rate (per 1,000 people)"
          : "Number of Marriages",
        "scale": { "zero": false, "nice": true }
      },
      "tooltip": isLine
        ? [
            { "field": "year", "title": "Year" },
            { "field": "rate", "title": "Marriage Rate", "format": ".1f" }
          ]
        : [
            { "field": "year", "title": "Year" },
            { "field": "abs", "title": "Number of Marriages", "format": "," }
          ]
    }
  });

  //  Interactive hover points for line chart
if (isLine) {
  // Add hover points for all data points
  spec.layer.push({
    "mark": { 
      "type": "point", 
      "size": 80, 
      "color": "#E75480",
      "opacity": 0.8,
      "stroke": "#E75480",
      "strokeWidth": 2
    },
    "encoding": {
      "x": { "field": "year", "type": "ordinal" },
      "y": { "field": "rate", "type": "quantitative" },
      "tooltip": [
        { "field": "year", "title": "Year" },
        { "field": "rate", "title": "Marriage Rate", "format": ".1f" }
      ]
    }
  });
}




  //  Render the chart
  vegaEmbed("#areaChart", spec, { renderer: "svg", actions: false }).catch(console.error);
};



document.getElementById("toggleChartBtn").addEventListener("click", () => {
  currentChartType = currentChartType === "bar" ? "line" : "bar";
  drawAreaChart(currentChartType);

  const button = document.getElementById("toggleChartBtn");

  if (currentChartType === "bar") {
    button.textContent = "Switch to Marriage Rate (Line Chart)";
    button.title = "View the trend in marriage rate (per 1,000 people) from 2017–2022";
  } else {
    button.textContent = "Switch to Number of Marriages (Bar Chart)";
    button.title = "View the total number of marriages recorded each year";
  }
});



//  Draw default (bar chart)
drawAreaChart("bar");


    // ===============================
//  Shared Y-axis + Multi-line charts
// ===============================
// Highest marriage rate across BOTH genders for the selected ages (2017–2022)
async function getYMax(selectedAges) {
  const res = await fetch(YEAR_AGEGROUP_CSV);
  const text = await res.text();

  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return 10;

  const headers = lines[0].split(",");
  const idx = {
    year: headers.indexOf("year"),
    sex:  headers.indexOf("sex"),
    age:  headers.indexOf("age"),
    rate: headers.indexOf("rate")  // ✅ use 'rate' column, not 'abs'
  };

  let maxRate = 0;
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(",");
    const year = Number(cols[idx.year]);
    const age  = cols[idx.age];
    const rate = Number(cols[idx.rate]); // ✅ true marriage rate

    if (
      year >= 2017 && year <= 2022 &&
      age !== "all" &&
      selectedAges.includes(age) &&
      !Number.isNaN(rate)
    ) {
      maxRate = Math.max(maxRate, rate);
    }
  }

  // small headroom + tidy
  const padded = Math.max(10, Math.ceil(maxRate * 1.05 / 10) * 10);
  return padded;
}


async function updateBothCharts(selectedAges) {
  const maxY = await getYMax(selectedAges); // shared max for both charts
  femaleMultiLineChart(selectedAges, maxY);
  maleMultiLineChart(selectedAges, maxY);
}
const femaleMultiLineChart = (selectedAges, maxY) => {
  const highlightAge = "30-34";
  const keyAges = ["20-24", "25-29", "30-34", "35-39", "40-44", "45-49"];

  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Female Marriage Rate by Age Group (2017–2022)",
    "width": 600,
    "height": 280,
    "background": "transparent",

    "data": { "url": YEAR_AGEGROUP_CSV, "format": { "type": "csv" } },

    "transform": [
      { "calculate": "toNumber(datum.year || datum.date)", "as": "year" },
      { "filter": "datum.sex == 'female'" },
      { "filter": {"field": "age", "oneOf": keyAges} },
      { "filter": "datum.year >= 2017 && datum.year <= 2022" }
    ],

    "layer": [
      // 🩶 Base lines (gray)
      {
        "mark": { "type": "line", "stroke": "#C0C0C0", "strokeWidth": 1.3, "opacity": 0.6 },
        "transform": [{ "filter": `datum.age != '${highlightAge}'` }],
        "encoding": {
"x": { 
  "field": "year", 
  "type": "ordinal", 
  "title": "Year",
  "axis": {
    "labelAngle": 0,
    "labelAlign": "center"
  }
},
"y": {
  "field": "rate",
  "type": "quantitative",
  "title": "Marriage Rate (per 1,000 people)",
  "scale": {"domain": [0, maxY]}  // 👈 ensure same Y-axis scale
},
          "detail": { "field": "age" }
        }
      },

      // 💜 Highlight line for 30–34
      {
        "mark": { "type": "line", "interpolate": "monotone", "strokeWidth": 3, "color": "#CE93D8" },
        "transform": [{ "filter": `datum.age == '${highlightAge}'` }],
        "encoding": {
          "x": { "field": "year", "type": "ordinal" },
          "y": { "field": "rate", "type": "quantitative" }
        }
      },

      // 🔹 Visible dots for all lines
      {
        "mark": { "type": "point", "size": 50, "filled": true, "opacity": 1 },
        "encoding": {
          "x": { "field": "year", "type": "ordinal" },
          "y": { "field": "rate", "type": "quantitative" },
          "color": {
            "condition": [
              { "test": `datum.age == '${highlightAge}'`, "value": "#CE93D8" }
            ],
            "value": "#C0C0C0"
          },
          "tooltip": [
            { "field": "year", "title": "Year" },
            { "field": "age", "title": "Age Group" },
            { "field": "rate", "title": "Marriage Rate (%)" }
          ]
        }
      },

      // 🏷️ Labels at 2022
      {
        "mark": { "type": "text", "align": "left", "baseline": "middle", "dx": 5, "font": "Arial", "fontSize": 11 },
        "transform": [
          { "filter": "datum.year == 2022" },
          { "filter": {"field": "age", "oneOf": keyAges} }
        ],
        "encoding": {
          "x": { "field": "year", "type": "ordinal" },
          "y": { "field": "rate", "type": "quantitative" },
          "text": { "field": "age" },
          "color": {
            "condition": [
              { "test": `datum.age == '${highlightAge}'`, "value": "#CE93D8" }
            ],
            "value": "#7d7d7d"
          }
        }
      }
    ],

    "config": {
      "font": "Arial",
      "tooltip": { "font": "Arial", "fontSize": 12 },
      "axis": {
        "labelFont": "Arial",
        "labelFontSize": 12,
        "titleFont": "Arial",
        "titleFontSize": 13,
        "titleFontWeight": "bold"
      },
      "view": { "stroke": "transparent" }
    }
  };

  vegaEmbed("#femaleMultiLineChart", spec, { renderer: "svg", actions: false })
    .catch(console.error);
};

const maleMultiLineChart = (selectedAges, maxY) => {
  const highlightAge = "30-34";
  const keyAges = ["20-24", "25-29", "30-34", "35-39", "40-44", "45-49"];

  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Male Marriage Rate by Age Group (2017–2022)",
    "width": 600,
    "height": 280,
    "background": "transparent",

    "data": { "url": YEAR_AGEGROUP_CSV, "format": { "type": "csv" } },

    "transform": [
      { "calculate": "toNumber(datum.year || datum.date)", "as": "year" },
      { "filter": "datum.sex == 'male'" },
      { "filter": {"field": "age", "oneOf": keyAges} },
      { "filter": "datum.year >= 2017 && datum.year <= 2022" }
    ],

    "layer": [
      // 🩶 Base gray lines
      {
        "mark": { "type": "line", "stroke": "#C0C0C0", "strokeWidth": 1.3, "opacity": 0.6 },
        "transform": [{ "filter": `datum.age != '${highlightAge}'` }],
        "encoding": {
"x": { 
  "field": "year", 
  "type": "ordinal", 
  "title": "Year",
  "axis": {
    "labelAngle": 0,
    "labelAlign": "center"
  }
},
"y": {
  "field": "rate",
  "type": "quantitative",
  "title": "Marriage Rate (per 1,000 people)",
  "scale": {"domain": [0, maxY]}  // 👈 ensure same Y-axis scale
},
          "detail": { "field": "age" }
        }
      },

      // 🧡 Highlight line
      {
        "mark": { "type": "line", "interpolate": "monotone", "strokeWidth": 3, "color": "#E59442" },
        "transform": [{ "filter": `datum.age == '${highlightAge}'` }],
        "encoding": { "x": { "field": "year", "type": "ordinal" }, "y": { "field": "rate", "type": "quantitative" } }
      },

      // 🔹 Visible points for tooltip
      {
        "mark": { "type": "point", "size": 50, "filled": true, "opacity": 1 },
        "encoding": {
          "x": { "field": "year", "type": "ordinal" },
          "y": { "field": "rate", "type": "quantitative" },
          "color": {
            "condition": [
              { "test": `datum.age == '${highlightAge}'`, "value": "#E59442" }
            ],
            "value": "#C0C0C0"
          },
          "tooltip": [
            { "field": "year", "title": "Year" },
            { "field": "age", "title": "Age Group" },
            { "field": "rate", "title": "Marriage Rate (%)" }
          ]
        }
      },

      // 🏷️ Labels at 2022
      {
        "mark": { "type": "text", "align": "left", "baseline": "middle", "dx": 5, "font": "Arial", "fontSize": 11 },
        "transform": [
          { "filter": "datum.year == 2022" },
          { "filter": {"field": "age", "oneOf": keyAges} }
        ],
        "encoding": {
          "x": { "field": "year", "type": "ordinal" },
          "y": { "field": "rate", "type": "quantitative" },
          "text": { "field": "age" },
          "color": {
            "condition": [
              { "test": `datum.age == '${highlightAge}'`, "value": "#E59442" }
            ],
            "value": "#7d7d7d"
          }
        }
      }
    ],

    "config": {
      "font": "Arial",
      "tooltip": { "font": "Arial", "fontSize": 12 },
      "axis": {
        "labelFont": "Arial",
        "labelFontSize": 12,
        "titleFont": "Arial",
        "titleFontSize": 13,
        "titleFontWeight": "bold"
      },
      "view": { "stroke": "transparent" }
    }
  };

  vegaEmbed("#maleMultiLineChart", spec, { renderer: "svg", actions: false })
    .catch(console.error);
};



// 🟪 Gender Difference Heatmap
// ==============================
const drawGenderDifferenceHeatmap = (containerId) => {
  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Marriage Rate Difference Between Men and Women (2017–2022)",
    "width": "container",
    "height": 360,
    "autosize": { "type": "fit", "contains": "content" },
    "background": "transparent",

    "data": { "url": YEAR_AGEGROUP_CSV, "format": { "type": "csv" } },

    "transform": [
      { "filter": "datum.age != 'all' && datum.year >= 2017 && datum.year <= 2022" },
      { "pivot": "sex", "value": "rate", "groupby": ["year", "age"] },
      {
        "calculate": `
          isValid(datum.Male) && isValid(datum.Female) ? datum.Male - datum.Female :
          isValid(datum.male) && isValid(datum.female) ? datum.male - datum.female : 0
        `,
        "as": "diff"
      },
  { "calculate": "abs(datum.diff)", "as": "absDiff" },
  {
    "calculate": "datum.diff > 0 ? 'Higher for Men' : datum.diff < 0 ? 'Higher for Women' : 'Equal rate'",
    "as": "trend"
  }
    ],

    "mark": {
      "type": "rect",
      "stroke": "#e8e8e8",         // ✅ slightly darker border for better visibility
      "strokeWidth": 0.8
    },

    "encoding": {
      "x": {
        "field": "year",
        "type": "ordinal",
        "title": "Year",
        "axis": { "labelAngle": 0, "labelFont": "Arial", "titleFont": "Arial" }
      },
      "y": {
        "field": "age",
        "type": "ordinal",
        "sort": allAges,
        "title": "Age Group",
        "axis": { "labelFont": "Arial", "titleFont": "Arial" }
      },
      "color": {
        "field": "diff",
        "type": "quantitative",
        "title": "Gender Difference (%)",
        "scale": {
          "domain": [-35, 0, 35],
          "range": ["#8E24AA", "#FFFFFF", "#CC7722"],  // 💜 female – 🟠 male
          "clamp": true
        },
"legend": {
  "orient": "bottom",
  "direction": "horizontal",
  "gradientLength": 480,
  "gradientThickness": 14,
  "offset": 30,
  "titleAnchor": "middle",
  "titleAlign": "center",
  "titleBaseline": "bottom",
  "titleFont": "Arial",
  "titleFontSize": 13,
  "titleFontWeight": "bold",
  "labelFont": "Arial",
  "labelFontSize": 12,
  "titleColor": "#333",
  "labelColor": "#333",
  // ✅ Only show 3 main tick positions
  "values": [-30, 0, 30],
  // ✅ One label per side, not repeated
  "labelExpr": "datum.value == -30 ? 'Higher for Women' : datum.value == 0 ? 'Equal' : 'Higher for Men'",
  "padding": 10
}

      },
      "tooltip": [
        { "field": "year", "title": "Year" },
        { "field": "age", "title": "Age Group" },
        { "field": "trend", "title": "Observation" },
{ "field": "absDiff", "title": "Difference (%)", "format": ".2f", "formatType": "number", "type": "quantitative" },
{ "calculate": "abs(datum.diff)", "as": "absDiff" }
      ]
    },

    "config": {
      "font": "Arial",
      "view": { "stroke": "transparent", "padding": 0 },
      "legend": {
        "layout": { "anchor": "middle" } // ✅ centers legend automatically
      },
      "padding": { "bottom": 100 }
    }
  };

  vegaEmbed(containerId, spec, { renderer: "svg", actions: false });
};


const drawWaffleChart = async () => {
  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": 400,
    "height": 400,
    "background": "transparent",

    "data": { "url": YEAR_AGEGROUP_CSV, "format": { "type": "csv" } },

    "transform": [
      { "filter": "datum.year == '2022' && datum.age == 'all'" },
      { "joinaggregate": [{ "op": "sum", "field": "rate", "as": "TotalRate" }] },
      { "calculate": "datum.rate / datum.TotalRate * 100", "as": "Percent" },
      { "calculate": "round(datum.Percent)", "as": "RoundedPercent" },
      { "window": [{ "op": "sum", "field": "RoundedPercent", "as": "Cumulative" }], "sort": [{ "field": "sex" }] },
      { "calculate": "datum.Cumulative - datum.RoundedPercent", "as": "Start" },
      { "calculate": "sequence(datum.Start, datum.Cumulative)", "as": "Squares" },
      { "flatten": ["Squares"] },
      { "calculate": "floor(datum.Squares / 10)", "as": "row" },
      { "calculate": "datum.Squares % 10", "as": "col" }
    ],

    "mark": {
      "type": "rect",
      "width": 35,
      "height": 35,
      "cornerRadius": 3,
      "stroke": "white",
      "strokeWidth": 1
    },

    "encoding": {
      "x": { "field": "col", "type": "ordinal", "axis": null },
      "y": { "field": "row", "type": "ordinal", "axis": null, "sort": "-y" },
      "color": {
        "field": "sex",
        "type": "nominal",
        "scale": {
          "domain": ["female", "male"],
          "range": ["#8E24AA", "#CC7722"]   // 💜 female = purple, 🟠 male = orange-brown
        },
        "legend": {
          "title": null,                    // ✅ removed legend title
          "orient": "bottom",
          "direction": "horizontal",
          "symbolType": "circle",
          "symbolSize": 90,
          "symbolStrokeWidth": 1,
          "symbolPadding": 10,
          "columnPadding": 25,
          "rowPadding": 5,
          "labelAlign": "center",
          "labelOffset": 20,
          "labelFont": "Arial",
          "labelFontSize": 12,
          "labelColor": "#333",
          "offset": 15,
          "padding": 10
        }
      },
      "tooltip": [
        { "field": "sex", "title": "Gender" },
        { "field": "rate", "title": "Marriage Rate (%)", "format": ".1f" }
      ]
    },

    "config": {
      "view": { "stroke": null },
      "legend": { "layout": { "anchor": "middle" } },
      "axis": { "grid": false }
    }
  };

  vegaEmbed("#waffleChart", spec, { renderer: "svg", actions: false })
    .catch(console.error);
};


    // ====== 🧭 SHARED ZOOM CONTROL ======
    let currentZoom = 2400;
    let currentPan = { x: 500, y: 275 };

    let selectedYear = 2022;
    let selectedSex = "female";
    let selectedAges = [...allAges];
    drawMap("male", selectedYear, "#maleVis");
    drawMap("female", selectedYear, "#femaleVis");
    updateBothCharts(selectedAges);
drawAreaChart("bar");  // ✅ start with bar chart (number of marriages)

drawGenderDifferenceHeatmap("#genderDiffHeatmap");
drawWaffleChart();


    // === YEAR SLIDER ===
    document.getElementById("yearSlider").addEventListener("input", e => {
      selectedYear = +e.target.value;
      document.getElementById("yearLabel").textContent = selectedYear;
      document.getElementById("chartTitle").textContent =
        `Marriage Rate in Malaysia (Male vs Female), ${selectedYear} (All Ages)`;
      drawMap("male", selectedYear, "#maleVis");
      drawMap("female", selectedYear, "#femaleVis");
    });


    // === AGE CHECKBOX EVENTS ===
document.querySelectorAll("input[name='ageBox']").forEach(cb => {
  cb.addEventListener("change", async () => {
    const allBoxes = document.querySelectorAll("input[name='ageBox']");
    const checked = Array.from(allBoxes)
      .filter(c => c.checked)
      .map(c => c.value);

    selectedAges = checked;
    // ✅ Recalculate Y max each time
    await updateBothCharts(selectedAges);


    // Update button label dynamically
    const selectAllBtn = document.getElementById("selectAllBtn");
    const allChecked = checked.length === allBoxes.length;
    selectAllBtn.textContent = allChecked ? "Clear All" : "Select All Age Groups";
  });
});


    // === SELECT ALL / CLEAR ALL BUTTON ===
// === SELECT ALL / CLEAR ALL BUTTON ===
document.getElementById("selectAllBtn").addEventListener("click", async () => {
  const allBoxes = document.querySelectorAll("input[name='ageBox']");
  const allChecked = Array.from(allBoxes).every(cb => cb.checked);

  // Toggle all
  allBoxes.forEach(cb => (cb.checked = !allChecked));
  selectedAges = !allChecked ? [...allAges] : [];

  // 🔁 Update BOTH charts dynamically
  await updateBothCharts(selectedAges);

  // Update button label
  document.getElementById("selectAllBtn").textContent = !allChecked
    ? "Clear All"
    : "Select All Age Groups";
});

function updateMaps() {
  // Redraw both maps with updated projection values
  const injectZoomSignal = (spec) => {
    spec.signals = [
      { name: "zoomScale", value: currentZoom },
      { name: "panX", value: currentPan.x },
      { name: "panY", value: currentPan.y }
    ];
    return spec;
  };

  drawMap("male", selectedYear, "#maleVis");
  drawMap("female", selectedYear, "#femaleVis");
}


// ====== 🖱️ DRAG TO PAN CONTROL (smoothed) ======
let isDragging = false;
let startX, startY;
let deltaX = 0, deltaY = 0;

document.addEventListener("mousedown", (e) => {
  isDragging = true;
  startX = e.clientX;
  startY = e.clientY;
  document.body.style.cursor = "grabbing";
});

document.addEventListener("mouseup", () => {
  isDragging = false;
  // Apply accumulated pan only once (no flicker)
  currentPan.x += deltaX * 0.5;
  currentPan.y += deltaY * 0.5;
  updateMaps(); // redraw once when drag ends
  deltaX = 0;
  deltaY = 0;
  document.body.style.cursor = "default";
});

document.addEventListener("mousemove", (e) => {
  if (!isDragging) return;
  deltaX = e.clientX - startX;
  deltaY = e.clientY - startY;
});


  </script>
</body>
</html>

