<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Marriage Rate in Malaysia (Female Focus)</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@6"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@6"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@7"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <style>
/* ====== PAGE LAYOUT STYLE (1080p MAX) ====== */
/* ===============================
   GLOBAL PAGE LAYOUT
================================= */
body {
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  background-color: #dcdcdc; /* Light grey page sides */
}

.main-container {
  max-width: 1600px;
  width: 100%;
  background-color: #FFF8DC; /* 🌼 Cornsilk tone */
  margin: 40px auto;
  padding: 40px 50px;
  border-radius: 12px;
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  box-sizing: border-box;
  border: none;
}

/* ===============================
   TYPOGRAPHY
================================= */

/* Main title */
#mainTitle {
  font-family: 'Playfair Display', serif;
  font-size: 46px;
  text-align: center;
  /* color: #5A3E00; */

  color: black;

  margin: 10px 0 8px 0;
  letter-spacing: 1px;
}

/* Subtitle */
#subTitle {
  font-family: 'Times New Roman', Times, serif;
  text-align: center;
  font-size: 20px;
  /* color: #6B5200; */
    color: black;

  margin-bottom: 35px;
  letter-spacing: 0.3px;
}

/* Section titles */
h2 {
  text-align: center;
  color: #111;
  font-family: 'Times New Roman', Times, serif;
  font-size: 30px;
  margin: 60px 0 15px 0;
  letter-spacing: 0.3px;
}

/* Subsection titles */
h3 {
  text-align: center;
  color: #111;
  font-family: 'Times New Roman', Times, serif;
  font-size: 22px;
  font-weight: bold;
  letter-spacing: 0.3px;
}

/* Text and paragraph styling */
p, label, button, #analysisSection, #areaText, #lineChartText, #heatmapText {
  font-family: Arial, sans-serif;
  color: #2E2E2E;
  line-height: 1.7;
  font-size: 15.5px;
}

/* ===============================
   VISUALISATION + CARD STYLE
================================= */

#waffleChart {
  background-color: white !important;
  margin: 0 auto;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0 !important;         /* remove inner padding */
  min-height: unset !important;  /* remove forced height */
  height: auto !important;
  overflow: visible;             /* allow chart edges to breathe */
}





.mapBox,
#areaChart,
#genderDiffHeatmap,
#waffleChart,
#analysisSection {
  background-color: #FFFFFF;
border: 1px solid #ccc;
  border-radius: 10px;
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  padding: 15px;
}

#maleMultiLineChart,
#femaleMultiLineChart {
  background: none;      /* remove white background */
  border: none;          /* no border outline */
  box-shadow: none;      /* remove drop shadow */
  padding: 0;            /* remove inner spacing */
}

/* ===============================
   SIDE-BY-SIDE CHARTS (MAP & MULTI-LINE)
================================= */
#mapContainer,
#lineChartContainer {
  display: flex;
  justify-content: space-between;    /* distribute both evenly */
  align-items: stretch;
  flex-wrap: nowrap;                 /* ✅ keep both charts in one row */
  gap: 20px;
  width: 100%;
  max-width: 1600px;
  margin: 20px auto 40px auto;
  box-sizing: border-box;
}

/* ✅ Each chart box auto-scales and keeps proper ratio */
.mapBox {
  flex: 1 1 48%;
  min-width: 480px;
  aspect-ratio: 4 / 3;
  background: white;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  padding: 35px 40px 30px 40px; /* 🔸 Added internal space */
  overflow: visible;            /* let annotations breathe */
  transition: all 0.3s ease;
}


/* ===============================
   RESPONSIVE AUTO-RESIZE
================================= */
@media (max-width: 1400px) {
  .mapBox {
    min-width: 420px;
    aspect-ratio: 4 / 3;
  }
}

@media (max-width: 1200px) {
  #mapContainer,
  #lineChartContainer {
    gap: 10px;
  }
  .mapBox {
    flex: 1 1 48%;
    transform: scale(0.9);           /* shrink both equally */
    transform-origin: top center;
  }
}

@media (max-width: 1000px) {
  .mapBox {
    transform: scale(0.8);
  }
}

@media (max-width: 800px) {
  #mapContainer,
  #lineChartContainer {
    flex-direction: column;          /* ✅ finally stack vertically */
    align-items: center;
  }
  .mapBox {
    width: 95%;
    transform: scale(1);
    min-width: 0;
  }
}


/* Center all charts */
#areaChartContainer,
#waffleChart,
#maleMultiLineChart,
#femaleMultiLineChart,
#maleVis,
#femaleVis {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 auto;
}

#genderDiffHeatmap {
  display: flex;
  justify-content: center;     /* 🔸 horizontally center the chart */
  align-items: center;         /* 🔸 vertically center it */
  width: 100%;
  margin: 0 auto;
  padding: 10px 0;             /* small breathing space top-bottom */
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  overflow: visible !important;
  box-sizing: border-box;
}
/* ===============================
   AREA CHART + FINDINGS BOX
================================= */
/* === AREA CHART CONTAINER & CHART === */
#areaChartContainer {
  width: 100%;
  max-width: 1600px;
  margin: 0 auto 20px auto;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: stretch;   /* ✅ stretch vertically */
  height: 400px;          /* ✅ fixed proportional height */
  box-sizing: border-box;
}

#areaChart {
  padding: 0;           /* ✅ remove any inner padding */
  margin: 0; 
    height: 100%;
  width: 100%;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  box-sizing: border-box;
  overflow: hidden;       /* ✅ prevent Vega SVG overflow */
}




#areaText,
#lineChartText,
#heatmapText,
#analysisSection {
  max-width: 1600px;  /* ✅ uniform width */
  margin: 25px auto;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 25px;
  text-align: center;
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  font-size: 15px;
  line-height: 1.6;
}


/* ===============================
   HEATMAP + WAFFLE (FLAT GRAPH INSIDE WHITE BOX)
================================= */
#heatmapWaffleContainer {
  display: flex;
  justify-content: space-between;
  align-items: stretch;
  gap: 25px;
  width: 100%;
  max-width: 1600px;
  margin: 30px auto;
  box-sizing: border-box;
}

/* 🔸 White rounded container behind chart */
.halfCard {
  flex: 1 1 48%;
  background: #ffffff;             /* white box background */
  border: 1px solid #ccc;          /* light border */
  border-radius: 10px;             /* rounded corners */
  box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* soft shadow behind */
  padding: 20px;                   /* space inside for chart */
  box-sizing: border-box;
  overflow: hidden;
  
}

/* 🔹 The chart itself: no background or shadow */
#genderDiffHeatmap,
#waffleChart {
  width: 100%;
  margin: 0 auto;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  overflow: visible !important;
}

/* Remove Vega embed default frame */
.vega-embed,
.vega-embed > div {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 0 !important;
}

/* Stack vertically on smaller screens */
@media (max-width: 900px) {
  #heatmapWaffleContainer {
    flex-direction: column;
    align-items: center;
  }
  .halfCard {
    width: 95%;
  }
}

/* 
/* ===============================
   CHECKBOX + BUTTON CONTROLS
================================= */
/* 
.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  max-width: 800px;
  margin: 0 auto;
}

.checkbox-group label {
  background: #f7f5ff;
  border: 1px solid #bbb;
  padding: 5px 10px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  user-select: none;
}

/* Select All button */
#selectAllBtn {
  background-color: #ddd;
  border: 1px solid #aaa;
  border-radius: 5px;
  padding: 5px 10px;
  font-size: 13px;
  cursor: pointer;
  margin-top: 10px;
  transition: background-color 0.2s ease;
}
#selectAllBtn:hover,
button:hover {
  background-color: #e5cc80;
  border-color: #d8b74a;
  color: #3B2C00;
}

/* Consistent visualisation card style */
.card {
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
} */ */

/* ===============================
   MISC ALIGNMENT
================================= */
h2, h3, #controls, #ageCheckboxContainer,
#zoomInBtn, #zoomOutBtn, #resetZoomBtn {
  text-align: center;
  margin-left: auto;
  margin-right: auto;
}

/* Tooltip, legend, and axis font consistency */
.vg-tooltip,
.vega-legend,
.vega-axis,
.vg-tooltip-content {
  font-family: Arial, sans-serif !important;
  font-size: 13px !important;
  color: #3B2C00 !important;
}

  </style>
</head>
<body>
  <div class="main-container">
    <h1 id="mainTitle">Marriage Trends in Malaysia, 2017–2022</h1>
<p id="subTitle">An analytical overview of marriage rates<br>across gender, age, and regions</p>



<!-- ✅ AREA CHART CARD SECTION -->
<div id="areaChartCard" style="
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  padding: 30px 40px 35px 40px;
  max-width: 1600px;
  margin: 30px auto;
  box-sizing: border-box;
">

  <!-- Title -->
  <h2 style="
    margin: 0 0 20px 0;
    font-family: 'Times New Roman';
    color: #2e2e2e;
    text-align: center;
  ">
    Marriage Trends in Malaysia (2017–2022)
  </h2>

  <!-- Chart -->
  <div id="areaChart" style="
    width: 100%;
    height: 380px;
    margin: 0 auto;
  "></div>

  <!-- Toggle Button (centered) -->
  <div style="
    text-align: center;
    margin-top: 20px;
  ">
    <button id="toggleChartBtn" style="
      background-color: #FFD580;        /* 🌼 Soft golden color */
      border: 1px solid #CFA15E;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: bold;
      color: #4B2E05;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    ">
      Switch to Marriage Rate (Line Chart)
    </button>
  </div>

</div>

<!-- ✅ Button Hover Effects -->
<style>
#toggleChartBtn:hover {
  background-color: #FFB347;           /* deeper orange hover */
  border-color: #A66615;
  color: #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.25);
}
#toggleChartBtn:active {
  background-color: #E69500;
  transform: scale(0.97);
}
</style>

<!-- 🟣 AREA CHART FINDINGS (unchanged design) -->
<div id="areaText" class="card" style="
  max-width: 1600px;
  margin: 20px auto;
  padding: 25px 40px;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  text-align: center;          
">

<div style="
  display: flex;                     /* ✅ replace grid with flex for centering */
  justify-content: center;           /* ✅ horizontal center */
  align-items: center;               /* ✅ vertical center */
  height: 220px;                     /* ✅ adjusts height to balance white space */
  font-family: Arial, sans-serif;
  font-size: 15px;
  line-height: 1.8;
  color: #333;
  max-width: 1000px;
  margin: 0 auto;
  text-align: center;
">
  <p style="
    margin: 0; 
    font-size: 18px; 
    line-height: 1.9; 
    max-width: 750px;
  ">
    Between 2017 and 2022, Malaysia’s<br>
    marriage trend remained generally stable,<br>
    with a sharp drop in 2020<br>
    due to pandemic restrictions,<br>
    followed by a strong rebound in 2021<br>
    and stabilisation in 2022,<br>
    reflecting a full recovery after disruption.
  </p>
</div>

</div>


    <!-- All your charts, maps, titles, controls go here -->
    <h2 id="chartTitle">Male & Female Marriage Rate in Malaysia, 2022 (All Ages)</h2>

<div id="controls" style="text-align:center; margin:20px 0;">
  <label for="yearSlider" style="font-weight:bold;">Year:</label>
  <input type="range" id="yearSlider" min="2017" max="2022" value="2022" step="1"
    style="width:300px; vertical-align:middle; margin:0 10px;" />
  <span id="yearLabel" class="small" style="font-weight:bold;">2022</span>
</div>


    <div style="text-align:center; margin:10px 0;">
      <button id="zoomInBtn">Zoom In (+)</button>
      <button id="zoomOutBtn">Zoom Out (−)</button>
      <button id="resetZoomBtn">Reset View</button>
    </div>

<div id="mapContainer">
  <div class="mapBox">
    <h3 style="text-align:center;">Male Marriage Rate</h3>
    <div id="maleVis"></div>
  </div>
  <div class="mapBox">
    <h3 style="text-align:center;">Female Marriage Rate</h3>
    <div id="femaleVis"></div>
  </div>
</div>
<div id="vis"></div>

<!-- 🟣 MAP ANALYSIS TEXT (Two Columns – Enlarged for Poster Readability) -->
<!-- 🟣 MAP ANALYSIS TEXT (Two Columns – 6–8 Words Per Line) -->
<div id="mapText" class="card" style="
  max-width: 1400px;
  margin: 40px auto 50px auto;
  padding: 35px 55px;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  font-family: Arial, sans-serif;
  color: #333;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 35px;
  text-align: justify;
  align-items: start;
">

  <!-- 🟣 Column 1 -->
  <p style="
    font-size: 19px;
    line-height: 2;
    margin: 0;
  ">
    Female marriage rates were higher across most states,<br>
    especially in Kedah, Terengganu, and Kelantan,<br>
    showing stronger cultural and religious influence.<br>
    Male rates fluctuated more with higher values<br>
    in Negeri Sembilan and lower in Sabah,<br>
    mainly due to migration and economic factors.  
  </p>

  <!-- 🟠 Column 2 -->
  <p style="
    font-size: 19px;
    line-height: 2;
    margin: 0;
  ">
    Urban areas such as Kuala Lumpur<br>
    and Putrajaya showed higher male than<br>
    female marriage rates, linked to modern<br>
    lifestyles and delayed marriage decisions.<br>
    Rural and traditional states maintained steadier<br>
    marriage activity for both genders,<br>
    reflecting strong cultural roots in Malaysia.  
  </p>
</div>


    <h2>Marriage Rate by Age Group (2017–2022)</h2>


<div id="lineChartContainer">
  <div class="mapBox">
    <h3 style="text-align:center;">Male Marriage Rate by Age Group</h3>
    <div id="maleMultiLineChart"></div>
  </div>
  <div class="mapBox">
    <h3 style="text-align:center;">Female Marriage Rate by Age Group</h3>
    <div id="femaleMultiLineChart"></div>
  </div>
</div>

<!-- 🟡 MULTILINE CHART FINDINGS -->
<div id="lineChartText" class="card" style="
  max-width: 1600px;
  margin: 20px auto;
  padding: 20px 40px;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
">
  <h3 style="text-align:center; font-family:'Times New Roman'; font-weight:bold; color:black; font-size:18px; margin-bottom:15px;">
    Findings
  </h3>
  <div style="
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 40px;
    font-family: Arial, sans-serif;
    font-size: 15px;
    line-height: 1.8;
    color: #333;
    max-width: 1400px;
    margin: 0 auto;
    text-align: left;
  ">
    <p style='margin:0'>
      From 2017 to 2022, the 25–29 age<br>
      group consistently led marriage rates<br>
      across genders. Women’s marriage peaks<br>
      appeared earlier, while men married<br>
      later around 30–34 years old.
    </p>
    <p style='margin:0'>
      In 2020, rates dropped in all<br>
      age groups due to lockdowns, yet<br>
      recovery was visible by 2021 as<br>
      ceremonies resumed. Many young<br>
      adults postponed weddings for stability.
    </p>
    <p style='margin:0'>
      These shifts reveal balance between<br>
      tradition and modern lifestyles.<br>
      Malaysians increasingly prioritize career<br>
      growth and education before marriage,<br>
      reflecting evolving social values.
    </p>
  </div>
</div>

<!-- ✅ GENDER DIFFERENCE & PROPORTION SECTION -->
<h2 style="
  text-align:center;
  font-family:'Times New Roman';
  color:#2e2e2e;
  margin-bottom:25px;
">
  Gender Difference & Proportion of Marriages (2022)
</h2>

<!-- 🟣 CHART CONTAINER -->
<div id="heatmapWaffleContainer" style="
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 30px;
  max-width: 1600px;
  margin: 0 auto 40px auto;
">

  <!-- 🟣 LEFT: Heatmap -->
  <div id="genderDiffHeatmapContainer" class="halfCard" style="
    flex: 1 1 48%;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    padding: 25px 35px 35px 35px;
    box-sizing: border-box;
  ">
    <h3 style="text-align:center; margin-top:8px;">
      Gender Difference Heatmap (Male − Female)
    </h3>
    <div id="genderDiffHeatmap"></div>
  </div>

  <!-- 🟡 RIGHT: Waffle -->
  <div id="waffleChartContainer" class="halfCard" style="
    flex: 1 1 48%;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    padding: 25px 35px 35px 35px;
    box-sizing: border-box;
  ">
    <h3 style="text-align:center; margin-top:8px;">
      Proportion of Marriages by Gender (All Ages, 2022)
    </h3>
    <div id="waffleChart"></div>
  </div>
</div>
<!-- 🟣 TEXT CONTAINERS SIDE-BY-SIDE (Equal Width & Height) -->
<div id="genderInsightContainer" style="
  display: flex;
  justify-content: center;
  align-items: stretch;   /* makes both same height */
  gap: 40px;
  flex-wrap: nowrap;
  max-width: 1400px;
  margin: 40px auto 60px auto;
">

  <!-- 🟣 LEFT Insight: Heatmap -->
  <div id="heatmapText" class="card" style="
    flex: 1;
    max-width: 50%;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    padding: 45px 55px;
    font-family: Arial, sans-serif;
    color: #333;
    text-align: justify;
    font-size: 20px;
    line-height: 2.1;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  ">
    <p style="margin: 0;">
      Malaysian women continue to marry younger and in higher numbers, while men increasingly delay marriage or remarry later in life.
      This reflects growing gender gaps in marriage timing, driven by women entering marriage earlier and men prioritising career or financial stability before settling down.
    </p>
  </div>

  <!-- 🟡 RIGHT Insight: Waffle -->
  <div id="waffleText" class="card" style="
    flex: 1;
    max-width: 50%;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    padding: 45px 55px;
    font-family: Arial, sans-serif;
    color: #333;
    text-align: justify;
    font-size: 20px;
    line-height: 2.1;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  ">
    <p style="margin: 0;">
      Female marriage rate (25.5) was higher than male (22.7), showing women married more actively and earlier.
      Men’s lower rate suggests delayed marriage due to career or financial factors, while women’s higher rate reflects stronger participation and traditional expectations in forming families.
    </p>
  </div>
</div>

<!-- 🔽 Responsive Layout -->
<style>
  @media (max-width: 1000px) {
    #genderInsightContainer {
      flex-direction: column;
      align-items: center;
    }

    #genderInsightContainer > div {
      max-width: 100%;
      margin-bottom: 25px;
    }
  }
</style>



<!-- 🔶 ANALYSIS SUMMARY -->
<div id="analysisSection" class="card" style="
  max-width: 1600px;
  margin: 40px auto;
  padding: 20px 40px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
">
  <h3 style="text-align:center; font-family:'Times New Roman'; font-weight:bold; font-size:18px; color:black; margin-bottom:15px;">
    Analysis Summary
  </h3>
  <div style="
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 40px;
    font-family: Arial, sans-serif;
    font-size: 15px;
    line-height: 1.8;
    color: #333;
    max-width: 1400px;
    margin: 0 auto;
    text-align: left;
  ">
    <p style='margin:0'>
      Between 2017 and 2022, Malaysia’s<br>
      marriage landscape changed with cultural<br>
      and economic influences. Marriage rates<br>
      dipped in 2020 during lockdowns, yet<br>
      rebounded swiftly by 2021.
    </p>
    <p style='margin:0'>
      Female marriage rates remained regionally<br>
      distinct — Kelantan and Terengganu higher,<br>
      urban states like Kuala Lumpur lower.<br>
      Among males, the 25–34 range stayed<br>
      most common for marriages.
    </p>
    <p style='margin:0'>
      Overall, Malaysia’s marriage trends<br>
      reflect recovery and continued diversity<br>
      in family formation, shaped by<br>
      modern priorities and traditional<br>
      expectations coexisting together.
    </p>
  </div>
</div>

<!-- ===============================
     📄 METADATA FOOTER (bottom-left)
=============================== -->
<footer style="
  position: relative;
  bottom: 0;
  left: 0;
  width: 100%;
  text-align: left;
  padding: 10px 40px;
  font-size: 13px;
  font-family: Arial, sans-serif;
  color: #555;
  background: transparent;
  margin-top: 40px;
  box-sizing: border-box;
">
  <p style="margin: 2px 0;"><strong>Author:</strong> Beh Zhi Yin</p>
  <p style="margin: 2px 0;"><strong>Date:</strong> 20 October 2025</p>
  <p style="margin: 2px 0;"><strong>Data Sources:</strong> 
    Department of Statistics Malaysia (DOSM); Natural Earth Data; World Bank Open Data
  </p>
</footer>



</body>


  <script>
    const STATE_AGE_CSV = "https://raw.githubusercontent.com/ZhiYin1018/3179/refs/heads/main/data/marriages_state_age.csv";
    const TOPOJSON_URL  = "https://raw.githubusercontent.com/ZhiYin1018/3179/refs/heads/main/data/malaysia-states.topojson";
    const FEMALE_CSV    = "https://raw.githubusercontent.com/ZhiYin1018/3179-W10-Homework/refs/heads/main/data/marriages_age.csv";
    const TOTALS_CSV    = "https://raw.githubusercontent.com/ZhiYin1018/3179-W10-Homework/refs/heads/main/data/marriage_all_gender.csv";
  


    const allAges = ["< 20","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65+"];

      const drawMap = (selectedSex, selectedYear, containerId) => {
      document.getElementById("chartTitle").textContent =
        `${selectedSex.charAt(0).toUpperCase() + selectedSex.slice(1)} Marriage Rate in Malaysia, ${selectedYear} (All Ages)`;

const colorRange = selectedSex === "female"
  // 💜 Purple gradient (light lavender → deep violet)
  ? ["#F3E5F5", "#E1BEE7", "#CE93D8", "#BA68C8", "#8E24AA", "#4A148C"]
  // 🟤 Orange-brown gradient (soft amber → deep brown-orange)
  : ["#FFE5B4", "#F2B179", "#E59442", "#CC7722", "#A65E1E", "#703800"];

      const spec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": 900,
        "height": 420,
        "background": "#cfeefb",
"projection": {
  "type": "mercator",
  "center": [111, 2.5],
  "scale": currentZoom,
  "translate": [currentPan.x, currentPan.y]
},


        "layer": [
          { "data": { "sphere": true }, "mark": { "type": "geoshape", "fill": "#cfeefb" } },
          {
            "data": { "graticule": { "step": [5, 5] } },
            "mark": { "type": "geoshape", "stroke": "#a0a8b0", "strokeWidth": 0.45, "opacity": 0.8 }
          },
          {
            "data": { "graticule": { "step": [90, 90] } },
            "mark": { "type": "geoshape", "stroke": "#8a949e", "strokeWidth": 1 }
          },
          {
            "data": { "url": STATE_AGE_CSV, "format": { "type": "csv" } },
            "transform": [
              { "calculate": "toNumber(datum.year || (substring(datum.date,0,4)))", "as": "year" },
              { "filter": `datum.year == ${selectedYear}` },
            { "filter": `datum.sex == '${selectedSex}'` },  
              { "filter": "datum.age == 'all'" },
              {
                "lookup": "state",
                "from": {
                  "data": { "url": TOPOJSON_URL, "format": { "type": "topojson", "feature": "gadm41_MYS_1" } },
                  "key": "properties.NAME_1"
                },
                "as": "geo"
              },
              { "filter": "datum.geo != null" }
            ],
            "mark": { "type": "geoshape", "stroke": "#fff", "strokeWidth": 0.6 },
            "encoding": {
              "shape": { "field": "geo", "type": "geojson" },
              "color": {
                "field": "rate",
                "type": "quantitative",
                "scale": { "type": "threshold", "domain": [18, 22, 25, 28, 32], "range": colorRange },
                "legend": {
                  "title": "Marriage Rate (per 1000)",
                  "orient": "bottom-right",
                  "direction": "horizontal",
                  "titleFont": "Arial",
                  "titleFontSize": 13,
                  "labelFont": "Arial",
                  "labelFontSize": 12,
                  "titleColor": "#4b3b00",
                  "labelColor": "#4b3b00"
                }
              },
              "tooltip": [
                { "field": "state", "title": "State" },
                { "field": "rate", "title": "Marriage Rate" },
                { "field": "year", "title": "Year" }
              ]
            }
          },

    // === ANNOTATION LINES ===
// === ANNOTATION LINES ===
{
  "data": {
    "values": [
      // ===== MALE: line ends match the male TEXT coords =====
      // 2017
      { "year": 2017, "sex": "male", "lon": 101.9, "lat": 2.8, "lon_end": 104.6, "lat_end": 3.1 }, // Negeri Sembilan → text (103.2, 3.1)
{ "year": 2017, "sex": "male", "lon": 117.0, "lat": 5.8, "lon_end": 113.5, "lat_end": 4.5 },

      // 2018
      { "year": 2018, "sex": "male", "lon": 102.2, "lat": 2.2, "lon_end": 104.3, "lat_end": 2.4 }, // Melaka → text (103.8, 2.4)
{ "year": 2018, "sex": "male", "lon": 117.0, "lat": 5.8, "lon_end": 113.1, "lat_end": 4.5 },

      // 2019
      { "year": 2019, "sex": "male", "lon": 101.9, "lat": 2.8, "lon_end": 104, "lat_end": 3.1 }, // Negeri Sembilan → text (103.2, 3.1)
{ "year": 2019, "sex": "male", "lon": 117.0, "lat": 5.8, "lon_end": 114, "lat_end": 4.5 },

      // 2020
      { "year": 2020, "sex": "male", "lon": 100.2, "lat": 6.5, "lon_end": 101.7, "lat_end": 6.7 }, // Perlis → text (101.8, 6.7)
{ "year": 2020, "sex": "male", "lon": 117.0, "lat": 6, "lon_end": 113, "lat_end": 4 },

      // 2021
      { "year": 2021, "sex": "male", "lon": 102.4, "lat": 6.1, "lon_end": 104.8, "lat_end": 6.45 }, // Kelantan → text (104.9, 6.45)
      { "year": 2021, "sex": "male", "lon": 103.3, "lat": 5.3, "lon_end": 104.7, "lat_end": 5.2 },  // Terengganu → text (104.8, 5.2)

      // 2022
      { "year": 2022, "sex": "male", "lon": 102.4, "lat": 6.1, "lon_end": 104.9, "lat_end": 6.3 },  // Kelantan → text (105.0, 6.3)
      { "year": 2022, "sex": "male", "lon": 103.5, "lat": 2.0, "lon_end": 104.7, "lat_end": 2.2 },  // Johor → text (104.8, 2.2)

      // ===== FEMALE: keep lines aligned to female TEXT coords =====
      // 2017
      { "year": 2017, "sex": "female", "lon": 102.3, "lat": 6.0, "lon_end": 104.0, "lat_end": 6.3 }, // Kelantan → text (104.0, 6.3)
      { "year": 2017, "sex": "female", "lon": 101.7, "lat": 2.9, "lon_end": 103.6, "lat_end": 3.2 }, // Putrajaya → text (103.6, 3.2)

      // 2018
      { "year": 2018, "sex": "female", "lon": 102.0, "lat": 6.0, "lon_end": 104.2, "lat_end": 5.2 }, // Kelantan → text (104.2, 5.2)
      { "year": 2018, "sex": "female", "lon": 103.0, "lat": 5.0, "lon_end": 104.2, "lat_end": 5.2 }, // Terengganu → text (104.0, 5.2)
      { "year": 2018, "sex": "female", "lon": 100.4, "lat": 6.2, "lon_end": 103.4, "lat_end": 6.5 }, // Kedah → text (102.2, 6.5)

      // 2019
      { "year": 2019, "sex": "female", "lon": 100.2, "lat": 6.6, "lon_end": 102, "lat_end": 6.8 }, // Perlis → text (102.1, 6.8)
      { "year": 2019, "sex": "female", "lon": 101.7, "lat": 2.9, "lon_end": 104, "lat_end": 3.1 }, // Putrajaya → text (103.5, 3.1)

      // 2020
      { "year": 2020, "sex": "female", "lon": 102.3, "lat": 6.0, "lon_end": 104.3, "lat_end": 6.2 }, // Kelantan → text (104.0, 6.2)
{ "year": 2020, "sex": "female", "lon": 117.0, "lat": 5.7, "lon_end": 113.8, "lat_end": 4.4 },

      // 2021
      { "year": 2021, "sex": "female", "lon": 100.4, "lat": 6.2, "lon_end": 103.9, "lat_end": 6.47 }, // Kedah → text (102.0, 6.4)
{ "year": 2021, "sex": "female", "lon": 117.0, "lat": 5.8, "lon_end": 108.6, "lat_end": 4.8 },

      // 2022
      { "year": 2022, "sex": "female", "lon": 102.3, "lat": 6.0, "lon_end": 103.9, "lat_end": 6.2 }, // Kelantan → text (104.0, 6.2)
{ "year": 2022, "sex": "female", "lon": 117.0, "lat": 5.8, "lon_end": 111.5, "lat_end": 4.4 },
    ]
  },
  "transform": [
    { "filter": `datum.year == ${selectedYear}` },
    { "filter": `datum.sex == '${selectedSex}'` }
  ],
  "mark": {
    "type": "rule",
    "stroke": selectedSex === "male" ? "#003366" : "black",
    "strokeWidth": 1.2
  },
  "encoding": {
    "longitude": { "field": "lon", "type": "quantitative" },
    "latitude": { "field": "lat", "type": "quantitative" },
    "longitude2": { "field": "lon_end" },
    "latitude2": { "field": "lat_end" }
  }
}
,
    // === ANNOTATION TEXTS ===
    {
"data": {
  "values": [

      { "year": 2017, "sex": "male", "text": "Negeri Sembilan’s men /n led Peninsular Malaysia./n Rate reached 31.8%", "lon": 105, "lat": 3.3 },
    { "year": 2017, "sex": "male", "text": "Sabah’s male rate was the lowest./nIt stood at 14.9‰.", "lon": 107, "lat": 4.5 },

    { "year": 2018, "sex": "male", "text": "Melaka’s registrations /nslowed slightly./nBacklogs delayed /nmany weddings", "lon": 105, "lat": 2.4 },
    { "year": 2018, "sex": "male", "text": "Sabah’s male rate slipped again./nThe drop was around −0.5‰.", "lon": 106.8, "lat": 4.5 },

    { "year": 2019, "sex": "male", "text": "Early marriage norms still persisted", "lon": 104.2, "lat": 3.1 },
    { "year": 2019, "sex": "male", "text": "Rural migration reduced local weddings", "lon": 106.5, "lat": 4.5 },

    { "year": 2020, "sex": "male", "text": "Perlis saw the steepest pandemic drop", "lon": 101.8, "lat": 6.7 },
    { "year": 2020, "sex": "male", "text": "Sabah’s male rate stagnated./nMCO restrictions halted ceremonies.", "lon": 106.5, "lat": 4.5 },

    { "year": 2021, "sex": "male", "text": "Kelantan was the fastest rebound nationwide.", "lon": 104.9, "lat": 6.45 },
    { "year": 2021, "sex": "male", "text": "Terengganu’s rate jumped sharply./n Many postponed weddings resumed.", "lon": 104.8, "lat": 5.2 },

    { "year": 2022, "sex": "male", "text": "Kelantan remained Malaysia’s highest male rate /n in 2011 & 2022", "lon": 105.0, "lat": 6.3 },
    { "year": 2022, "sex": "male", "text": "Urban cost pressures /n caused the drop.", "lon": 104.8, "lat": 2.2 },

    // === FEMALE ANNOTATIONS ===
    { "year": 2017, "sex": "female", "text": "Kelantan’s women marry earlier./n Customs kept rates above 30%", "lon": 104.3, "lat": 6.3 },
    { "year": 2017, "sex": "female", "text": "Civil service population is mostly single", "lon": 103.9, "lat": 3.2 },

    { "year": 2018, "sex": "female", "text": "Terengganu and Kelantan led again./nFaith-based norms stayed strong.", "lon": 104.2, "lat": 5.2 },
    { "year": 2018, "sex": "female", "text": "Kedah’s rise began early./nDigital registration helped rural growth.", "lon": 103.5, "lat": 6.5 },

    { "year": 2019, "sex": "female", "text": "Perlis stayed steady.Many women returned home to register locally.", "lon": 102.1, "lat": 6.8 },
    { "year": 2019, "sex": "female", "text": "Putrajaya’s modern lifestyle /ncause rate fell slightly.", "lon": 104, "lat": 3.7 },

    { "year": 2020, "sex": "female", "text": "Kelantan adapted to MCO./nOnline solemnisation kept rates steady.", "lon": 104.5, "lat": 6.2 },
    { "year": 2020, "sex": "female", "text": "Sabah’s rural lockdowns froze marriages./nRates plunged sharply.", "lon": 106, "lat": 4.4 },

    { "year": 2021, "sex": "female", "text": "Kedah’s rural rebound was strong./nIt outpaced industrial states.", "lon": 104.0, "lat": 6.4 },
    { "year": 2021, "sex": "female", "text": "Sabah’s female rates recovered slowly./nPost-MCO effects still lingered.", "lon": 106, "lat": 4.4 },

    { "year": 2022, "sex": "female", "text": "Kelantan’s women remained highest./nTraditions kept rates near 32.3%", "lon": 104.0, "lat": 6.2 },
    { "year": 2022, "sex": "female", "text": "Sabah improved slightly./nRegistry digitisation boosted access.", "lon": 106, "lat": 4.4 }
  ]
}
,
      "transform": [
        { "filter": `datum.year == ${selectedYear}` },
        { "filter": `datum.sex == '${selectedSex}'` }
      ],
"mark": {
  "type": "text",
  "font": "Arial",
  "fontSize": 18,
  "align": "left",
  "color": selectedSex === "male" ? "#003366" : "#000000",
  "dx": -4,
  "dy": -2,
  "lineBreak": "/n"
},

      "encoding": {
        "longitude": { "field": "lon", "type": "quantitative" },
        "latitude": { "field": "lat", "type": "quantitative" },
        "text": { "field": "text" }
      }
    }
  ]
};
    vegaEmbed(containerId, spec, { renderer: "svg", actions: false, tooltip: { theme: "custom" } })
    .then(res => {
        // Apply custom tooltip styling
        const tooltipEl = document.querySelector('.vg-tooltip');
        if (tooltipEl) {
        tooltipEl.style.fontFamily = 'Arial, sans-serif';
        tooltipEl.style.fontSize = '12px';
        tooltipEl.style.fontWeight = 'normal';
        tooltipEl.style.color = '#000';
        }
    })
    .catch(console.error);
    };

 let currentChartType = "bar"; // 🟡 default = bar chart (number of marriages)

 
const drawAreaChart = (chartType = "bar") => {
  const isLine = chartType === "line";

  // Base chart spec
  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Malaysia Marriage Trends (2017–2022)",
    "data": { "url": TOTALS_CSV, "format": { "type": "csv" } },
    "transform": [
      { "calculate": "toNumber(datum.date)", "as": "year" },
      { "filter": "datum.year >= 2017 && datum.year <= 2022" }
    ],
    "width": "container",
    "height": 350,
    "autosize": { "type": "fit", "contains": "content" },
    "background": "white",
    "layer": [],
    "config": {
      "axis": {
        "labelFont": "Arial",
        "labelFontSize": 12,
        "titleFont": "Arial",
        "titleFontSize": 13,
        "titleFontWeight": "bold"
      },
      "view": { "stroke": "transparent" },
      "style": {
        "tooltip": {
          "font": "Arial",
          "fontSize": 13,
          "fontWeight": "normal",
          "fill": "#000",
          "stroke": "none"
        }
      }
    }
  };

  // 🟣 Main line/bar chart
  spec.layer.push({
    "mark": isLine
      ? { "type": "line", "color": "#E75480", "strokeWidth": 3, "interpolate": "monotone" }
      : { "type": "bar", "color": "#F8BBD0", "cornerRadiusEnd": 3, "opacity": 0.9 },
    "encoding": {
      "x": {
        "field": "year",
        "type": "ordinal",
        "title": "Year",
        "axis": { "labelAngle": 0 }
      },
      "y": {
        "field": isLine ? "rate" : "abs",
        "type": "quantitative",
        "title": isLine
          ? "Marriage Rate (per 1,000 people)"
          : "Number of Marriages",
        "scale": { "zero": false, "nice": true }
      },
      "tooltip": isLine
        ? [
            { "field": "year", "title": "Year" },
            { "field": "rate", "title": "Marriage Rate", "format": ".1f" }
          ]
        : [
            { "field": "year", "title": "Year" },
            { "field": "abs", "title": "Number of Marriages", "format": "," }
          ]
    }
  });

  // 💬 Annotations only for line chart
if (isLine) {
  const annoData = {
    "values": [
      { "year": "2020", "rate": 21.6, "label": "Drop from COVID-19 lockdowns." }
    ]
  };

  // 💗 Dot exactly on 2020 rate point
  spec.layer.push({
    "data": annoData,
    "mark": { "type": "point", "size": 70, "color": "#E75480" },
    "encoding": {
      "x": { "field": "year", "type": "ordinal" },
      "y": { "field": "rate", "type": "quantitative" }
    }
  });

  // 💗 Annotation text just below the 2020 dot
  spec.layer.push({
    "data": annoData,
    "mark": {
      "type": "text",
      "align": "center",
      "baseline": "top",   // places text below
      "dy": 18,            // vertical offset downward
      "font": "Arial",
      "fontSize": 12,
      "color": "#E75480",
      "fontWeight": "bold"
    },
    "encoding": {
      "x": { "field": "year", "type": "ordinal" },
      "y": { "field": "rate", "type": "quantitative" },
      "text": { "field": "label" }
    }
  });
}




  // 🧩 Render the chart
  vegaEmbed("#areaChart", spec, { renderer: "svg", actions: false }).catch(console.error);
};



document.getElementById("toggleChartBtn").addEventListener("click", () => {
  currentChartType = currentChartType === "bar" ? "line" : "bar";
  drawAreaChart(currentChartType);

  const button = document.getElementById("toggleChartBtn");

  if (currentChartType === "bar") {
    button.textContent = "Switch to Marriage Rate (Line Chart)";
    button.title = "View the trend in marriage rate (per 1,000 people) from 2017–2022";
  } else {
    button.textContent = "Switch to Number of Marriages (Bar Chart)";
    button.title = "View the total number of marriages recorded each year";
  }
});



// 🟡 Draw default (bar chart)
drawAreaChart("bar");


    // ===============================
//  Shared Y-axis + Multi-line charts
// ===============================
// Highest marriage rate across BOTH genders for the selected ages (2017–2022)
async function getYMax(selectedAges) {
  const res = await fetch(FEMALE_CSV);
  const text = await res.text();

  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return 10;

  const headers = lines[0].split(",");
  const idx = {
    year: headers.indexOf("year"),
    sex:  headers.indexOf("sex"),
    age:  headers.indexOf("age"),
    rate: headers.indexOf("rate")  // ✅ use 'rate' column, not 'abs'
  };

  let maxRate = 0;
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split(",");
    const year = Number(cols[idx.year]);
    const age  = cols[idx.age];
    const rate = Number(cols[idx.rate]); // ✅ true marriage rate

    if (
      year >= 2017 && year <= 2022 &&
      age !== "all" &&
      selectedAges.includes(age) &&
      !Number.isNaN(rate)
    ) {
      maxRate = Math.max(maxRate, rate);
    }
  }

  // small headroom + tidy
  const padded = Math.max(10, Math.ceil(maxRate * 1.05 / 10) * 10);
  return padded;
}


async function updateBothCharts(selectedAges) {
  const maxY = await getYMax(selectedAges); // shared max for both charts
  femaleMultiLineChart(selectedAges, maxY);
  maleMultiLineChart(selectedAges, maxY);
}
const femaleMultiLineChart = () => {
  const highlightAge = "30-34";
  const keyAges = ["20-24", "25-29", "30-34", "35-39", "40-44", "45-49"];

  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Female Marriage Rate by Age Group (2017–2022)",
    "width": 600,
    "height": 280,
    "background": "transparent",

    "data": { "url": FEMALE_CSV, "format": { "type": "csv" } },

    "transform": [
      { "calculate": "toNumber(datum.year || datum.date)", "as": "year" },
      { "filter": "datum.sex == 'female'" },
      { "filter": {"field": "age", "oneOf": keyAges} },
      { "filter": "datum.year >= 2017 && datum.year <= 2022" }
    ],

    "layer": [
      // 🩶 Base lines (gray)
      {
        "mark": { "type": "line", "stroke": "#C0C0C0", "strokeWidth": 1.3, "opacity": 0.6 },
        "transform": [{ "filter": `datum.age != '${highlightAge}'` }],
        "encoding": {
"x": { 
  "field": "year", 
  "type": "ordinal", 
  "title": "Year",
  "labelAngle": 0,
  "labelAlign": "center"
},
          "y": { "field": "rate", "type": "quantitative", "title": "Marriage Rate (per 1,000 people)" },
          "detail": { "field": "age" }
        }
      },

      // 💜 Highlight line for 30–34
      {
        "mark": { "type": "line", "interpolate": "monotone", "strokeWidth": 3, "color": "#CE93D8" },
        "transform": [{ "filter": `datum.age == '${highlightAge}'` }],
        "encoding": {
          "x": { "field": "year", "type": "ordinal" },
          "y": { "field": "rate", "type": "quantitative" }
        }
      },

      // 🔹 Visible dots for all lines
      {
        "mark": { "type": "point", "size": 50, "filled": true, "opacity": 1 },
        "encoding": {
          "x": { "field": "year", "type": "ordinal" },
          "y": { "field": "rate", "type": "quantitative" },
          "color": {
            "condition": [
              { "test": `datum.age == '${highlightAge}'`, "value": "#CE93D8" }
            ],
            "value": "#C0C0C0"
          },
          "tooltip": [
            { "field": "year", "title": "Year" },
            { "field": "age", "title": "Age Group" },
            { "field": "rate", "title": "Marriage Rate" }
          ]
        }
      },

      // 🏷️ Labels at 2022
      {
        "mark": { "type": "text", "align": "left", "baseline": "middle", "dx": 5, "font": "Arial", "fontSize": 11 },
        "transform": [
          { "filter": "datum.year == 2022" },
          { "filter": {"field": "age", "oneOf": keyAges} }
        ],
        "encoding": {
          "x": { "field": "year", "type": "ordinal" },
          "y": { "field": "rate", "type": "quantitative" },
          "text": { "field": "age" },
          "color": {
            "condition": [
              { "test": `datum.age == '${highlightAge}'`, "value": "#CE93D8" }
            ],
            "value": "#7d7d7d"
          }
        }
      }
    ],

    "config": {
      "font": "Arial",
      "tooltip": { "font": "Arial", "fontSize": 12 },
      "axis": {
        "labelFont": "Arial",
        "labelFontSize": 12,
        "titleFont": "Arial",
        "titleFontSize": 13,
        "titleFontWeight": "bold"
      },
      "view": { "stroke": "transparent" }
    }
  };

  vegaEmbed("#femaleMultiLineChart", spec, { renderer: "svg", actions: false })
    .catch(console.error);
};

const maleMultiLineChart = () => {
  const highlightAge = "30-34";
  const keyAges = ["20-24", "25-29", "30-34", "35-39", "40-44", "45-49"];

  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Male Marriage Rate by Age Group (2017–2022)",
    "width": 600,
    "height": 280,
    "background": "transparent",

    "data": { "url": FEMALE_CSV, "format": { "type": "csv" } },

    "transform": [
      { "calculate": "toNumber(datum.year || datum.date)", "as": "year" },
      { "filter": "datum.sex == 'male'" },
      { "filter": {"field": "age", "oneOf": keyAges} },
      { "filter": "datum.year >= 2017 && datum.year <= 2022" }
    ],

    "layer": [
      // 🩶 Base gray lines
      {
        "mark": { "type": "line", "stroke": "#C0C0C0", "strokeWidth": 1.3, "opacity": 0.6 },
        "transform": [{ "filter": `datum.age != '${highlightAge}'` }],
        "encoding": {
"x": { 
  "field": "year", 
  "type": "ordinal", 
  "title": "Year",
  "labelAngle": 0,
  "labelAlign": "center"
},
          "y": { "field": "rate", "type": "quantitative", "title": "Marriage Rate (per 1,000 people)" },
          "detail": { "field": "age" }
        }
      },

      // 🧡 Highlight line
      {
        "mark": { "type": "line", "interpolate": "monotone", "strokeWidth": 3, "color": "#E59442" },
        "transform": [{ "filter": `datum.age == '${highlightAge}'` }],
        "encoding": { "x": { "field": "year", "type": "ordinal" }, "y": { "field": "rate", "type": "quantitative" } }
      },

      // 🔹 Visible points for tooltip
      {
        "mark": { "type": "point", "size": 50, "filled": true, "opacity": 1 },
        "encoding": {
          "x": { "field": "year", "type": "ordinal" },
          "y": { "field": "rate", "type": "quantitative" },
          "color": {
            "condition": [
              { "test": `datum.age == '${highlightAge}'`, "value": "#E59442" }
            ],
            "value": "#C0C0C0"
          },
          "tooltip": [
            { "field": "year", "title": "Year" },
            { "field": "age", "title": "Age Group" },
            { "field": "rate", "title": "Marriage Rate" }
          ]
        }
      },

      // 🏷️ Labels at 2022
      {
        "mark": { "type": "text", "align": "left", "baseline": "middle", "dx": 5, "font": "Arial", "fontSize": 11 },
        "transform": [
          { "filter": "datum.year == 2022" },
          { "filter": {"field": "age", "oneOf": keyAges} }
        ],
        "encoding": {
          "x": { "field": "year", "type": "ordinal" },
          "y": { "field": "rate", "type": "quantitative" },
          "text": { "field": "age" },
          "color": {
            "condition": [
              { "test": `datum.age == '${highlightAge}'`, "value": "#E59442" }
            ],
            "value": "#7d7d7d"
          }
        }
      }
    ],

    "config": {
      "font": "Arial",
      "tooltip": { "font": "Arial", "fontSize": 12 },
      "axis": {
        "labelFont": "Arial",
        "labelFontSize": 12,
        "titleFont": "Arial",
        "titleFontSize": 13,
        "titleFontWeight": "bold"
      },
      "view": { "stroke": "transparent" }
    }
  };

  vegaEmbed("#maleMultiLineChart", spec, { renderer: "svg", actions: false })
    .catch(console.error);
};



// 🟪 Gender Difference Heatmap
// ==============================
const drawGenderDifferenceHeatmap = (containerId) => {
  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Marriage Rate Difference Between Men and Women (2017–2022)",
    "width": "container",
    "height": 360,
    "autosize": { "type": "fit", "contains": "content" },
    "background": "transparent",

    "data": { "url": FEMALE_CSV, "format": { "type": "csv" } },

    "transform": [
      { "filter": "datum.age != 'all' && datum.year >= 2017 && datum.year <= 2022" },
      { "pivot": "sex", "value": "rate", "groupby": ["year", "age"] },
      {
        "calculate": `
          isValid(datum.Male) && isValid(datum.Female) ? datum.Male - datum.Female :
          isValid(datum.male) && isValid(datum.female) ? datum.male - datum.female : 0
        `,
        "as": "diff"
      },
      {
        "calculate": "datum.diff > 0 ? 'Higher for Men' : datum.diff < 0 ? 'Higher for Women' : 'Equal rate'",
        "as": "trend"
      }
    ],

    "mark": {
      "type": "rect",
      "stroke": "#e8e8e8",         // ✅ slightly darker border for better visibility
      "strokeWidth": 0.8
    },

    "encoding": {
      "x": {
        "field": "year",
        "type": "ordinal",
        "title": "Year",
        "axis": { "labelAngle": 0, "labelFont": "Arial", "titleFont": "Arial" }
      },
      "y": {
        "field": "age",
        "type": "ordinal",
        "sort": allAges,
        "title": "Age Group",
        "axis": { "labelFont": "Arial", "titleFont": "Arial" }
      },
      "color": {
        "field": "diff",
        "type": "quantitative",
        "title": "Gender Difference (‰)",
        "scale": {
          "domain": [-35, 0, 35],
          "range": ["#8E24AA", "#FFFFFF", "#CC7722"],  // 💜 female – 🟠 male
          "clamp": true
        },
"legend": {
  "orient": "bottom",
  "direction": "horizontal",
  "gradientLength": 480,
  "gradientThickness": 14,
  "offset": 30,
  "titleAnchor": "middle",
  "titleAlign": "center",
  "titleBaseline": "bottom",
  "titleFont": "Arial",
  "titleFontSize": 13,
  "titleFontWeight": "bold",
  "labelFont": "Arial",
  "labelFontSize": 12,
  "titleColor": "#333",
  "labelColor": "#333",
  // ✅ Only show 3 main tick positions
  "values": [-30, 0, 30],
  // ✅ One label per side, not repeated
  "labelExpr": "datum.value == -30 ? 'Higher for Women' : datum.value == 0 ? 'Equal' : 'Higher for Men'",
  "padding": 10
}

      },
      "tooltip": [
        { "field": "year", "title": "Year" },
        { "field": "age", "title": "Age Group" },
        { "field": "trend", "title": "Observation" },
        { "field": "diff", "title": "Difference (‰)", "format": "+.2f" }
      ]
    },

    "config": {
      "font": "Arial",
      "view": { "stroke": "transparent", "padding": 0 },
      "legend": {
        "layout": { "anchor": "middle" } // ✅ centers legend automatically
      },
      "padding": { "bottom": 100 }
    }
  };

  vegaEmbed(containerId, spec, { renderer: "svg", actions: false });
};


const drawWaffleChart = async () => {
  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": 400,
    "height": 400,
    "background": "transparent",

    "data": { "url": FEMALE_CSV, "format": { "type": "csv" } },

    "transform": [
      { "filter": "datum.year == '2022' && datum.age == 'all'" },
      { "joinaggregate": [{ "op": "sum", "field": "rate", "as": "TotalRate" }] },
      { "calculate": "datum.rate / datum.TotalRate * 100", "as": "Percent" },
      { "calculate": "round(datum.Percent)", "as": "RoundedPercent" },
      { "window": [{"op": "sum", "field": "RoundedPercent", "as": "Cumulative"}], "sort": [{"field": "sex"}] },
      { "calculate": "datum.Cumulative - datum.RoundedPercent", "as": "Start" },
      { "calculate": "sequence(datum.Start, datum.Cumulative)", "as": "Squares" },
      { "flatten": ["Squares"] },
      { "calculate": "floor(datum.Squares / 10)", "as": "row" },
      { "calculate": "datum.Squares % 10", "as": "col" }
    ],

    "mark": {
      "type": "rect",
      "width": 35,
      "height": 35,
      "cornerRadius": 3,
      "stroke": "white",
      "strokeWidth": 1
    },

    "encoding": {
      "x": { "field": "col", "type": "ordinal", "axis": null },
      "y": { "field": "row", "type": "ordinal", "axis": null, "sort": "-y" },
      "color": {
        "field": "sex",
        "type": "nominal",
        "scale": {
          "domain": ["female", "male"],
          "range": ["#8E24AA", "#CC7722"]   // 💜 female = purple, 🟠 male = orange-brown
        },
"legend": {
  "title": "Gender",
  "orient": "bottom",
  "direction": "horizontal",
  "symbolType": "circle",
  "symbolSize": 90,              // 🔹 slightly smaller circles
  "symbolStrokeWidth": 1,
  "symbolPadding": 10,           // 🔹 adds space between symbol and text
  "columnPadding": 25,           // 🔹 adds space between male/female groups
  "rowPadding": 5,
  "titleAnchor": "middle",
  "titleAlign": "center",
  "titleBaseline": "bottom",
  "labelAlign": "center",
  "labelOffset": 20,              // 🔹 moves text a bit further from symbol
  "titleFont": "Playfair Display",
  "titleFontSize": 13,
  "titleFontWeight": "bold",
  "labelFont": "Arial",
  "labelFontSize": 12,
  "labelColor": "#333",
  "offset": 15,                  // space between chart & legend
  "padding": 10
}


      },
      "tooltip": [
        { "field": "sex", "title": "Gender" },
        { "field": "rate", "title": "Marriage Rate (‰)", "format": ".1f" }
      ]
    },
    "config": {
      "view": { "stroke": null },
      "legend": { "layout": { "anchor": "middle" } },  // ✅ keeps legend centered globally
      "axis": { "grid": false }
    }
  };

  vegaEmbed("#waffleChart", spec, { renderer: "svg", actions: false })
    .catch(console.error);
};



    // ====== 🧭 SHARED ZOOM CONTROL ======
    let currentZoom = 2400;
    let currentPan = { x: 500, y: 275 };

    let selectedYear = 2022;
    let selectedSex = "female";
    let selectedAges = [...allAges];
    drawMap("male", selectedYear, "#maleVis");
    drawMap("female", selectedYear, "#femaleVis");
    updateBothCharts(selectedAges);
drawAreaChart("bar");  // ✅ start with bar chart (number of marriages)

drawGenderDifferenceHeatmap("#genderDiffHeatmap");
drawWaffleChart();


    // === YEAR SLIDER ===
    document.getElementById("yearSlider").addEventListener("input", e => {
      selectedYear = +e.target.value;
      document.getElementById("yearLabel").textContent = selectedYear;
      document.getElementById("chartTitle").textContent =
        `Marriage Rate in Malaysia (Male vs Female), ${selectedYear} (All Ages)`;
      drawMap("male", selectedYear, "#maleVis");
      drawMap("female", selectedYear, "#femaleVis");
    });


    // === AGE CHECKBOX EVENTS ===
document.querySelectorAll("input[name='ageBox']").forEach(cb => {
  cb.addEventListener("change", async () => {
    const allBoxes = document.querySelectorAll("input[name='ageBox']");
    const checked = Array.from(allBoxes)
      .filter(c => c.checked)
      .map(c => c.value);

    selectedAges = checked;
    // ✅ Recalculate Y max each time
    await updateBothCharts(selectedAges);


    // Update button label dynamically
    const selectAllBtn = document.getElementById("selectAllBtn");
    const allChecked = checked.length === allBoxes.length;
    selectAllBtn.textContent = allChecked ? "Clear All" : "Select All Age Groups";
  });
});


    // === SELECT ALL / CLEAR ALL BUTTON ===
// === SELECT ALL / CLEAR ALL BUTTON ===
document.getElementById("selectAllBtn").addEventListener("click", async () => {
  const allBoxes = document.querySelectorAll("input[name='ageBox']");
  const allChecked = Array.from(allBoxes).every(cb => cb.checked);

  // Toggle all
  allBoxes.forEach(cb => (cb.checked = !allChecked));
  selectedAges = !allChecked ? [...allAges] : [];

  // 🔁 Update BOTH charts dynamically
  await updateBothCharts(selectedAges);

  // Update button label
  document.getElementById("selectAllBtn").textContent = !allChecked
    ? "Clear All"
    : "Select All Age Groups";
});

function updateMaps() {
  // Redraw both maps with updated projection values
  const injectZoomSignal = (spec) => {
    spec.signals = [
      { name: "zoomScale", value: currentZoom },
      { name: "panX", value: currentPan.x },
      { name: "panY", value: currentPan.y }
    ];
    return spec;
  };

  drawMap("male", selectedYear, "#maleVis");
  drawMap("female", selectedYear, "#femaleVis");
}

document.getElementById("zoomInBtn").addEventListener("click", () => {
  currentZoom *= 1.2;
  updateMaps();
});

document.getElementById("zoomOutBtn").addEventListener("click", () => {
  currentZoom /= 1.2;
  updateMaps();
});

document.getElementById("resetZoomBtn").addEventListener("click", () => {
  currentZoom = 2400;
  currentPan = { x: 500, y: 275 };
  updateMaps();
});

// ====== 🖱️ DRAG TO PAN CONTROL (smoothed) ======
let isDragging = false;
let startX, startY;
let deltaX = 0, deltaY = 0;

document.addEventListener("mousedown", (e) => {
  isDragging = true;
  startX = e.clientX;
  startY = e.clientY;
  document.body.style.cursor = "grabbing";
});

document.addEventListener("mouseup", () => {
  isDragging = false;
  // Apply accumulated pan only once (no flicker)
  currentPan.x += deltaX * 0.5;
  currentPan.y += deltaY * 0.5;
  updateMaps(); // redraw once when drag ends
  deltaX = 0;
  deltaY = 0;
  document.body.style.cursor = "default";
});

document.addEventListener("mousemove", (e) => {
  if (!isDragging) return;
  deltaX = e.clientX - startX;
  deltaY = e.clientY - startY;
});


  </script>
</body>
</html>
